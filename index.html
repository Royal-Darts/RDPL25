<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Royal Darts Premier League 2025</title>
  <link rel="icon" href="logo.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.322.0/font/lucide.css"/>
  <style>
    :root {
      --primary: #171e30;
      --primary2: #22355c;
      --primary-light: #e9f3ff;
      --accent: #38b6ff;
      --accent2: #ffc93a;
      --card: #fff;
      --nav-bg: #1b2a50;
      --nav-text: #e2eaf5;
      --nav-active: #ffc93a;
      --nav-shadow: 0 2px 18px #22355c80;
      --table-border: #e2ecf4;
      --wa-green: #25D366;
      --font-sans: 'Segoe UI', Arial, sans-serif;
      --font-heading: 'Segoe UI Semibold', Arial, sans-serif;
      --page-padding: 12px;
      --table-font: 0.90em;
      --min-font: 13px;
    }
    html, body {
      background: #f7fafd;
      color: #1d253c;
      font-family: var(--font-sans);
      margin: 0; padding: 0;
      min-height: 100vh;
      height: 100%;
      font-size: 14.5px;
      line-height: 1.35;
      scroll-behavior: smooth;
    }
    body {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      height: 100vh;
      box-sizing: border-box;
      background-image: linear-gradient(120deg, #e9f3ff 0%, #ffffff 100%);
      font-size: var(--min-font);
      letter-spacing: 0.01em;
    }
    header {
      background: linear-gradient(120deg, var(--primary2) 80%, var(--accent) 120%);
      color: #fff;
      padding: 0.5rem var(--page-padding) 0.45rem var(--page-padding);
      display: flex;
      align-items: center;
      gap: 0.6em;
      border-bottom: 1px solid #b2d9fc;
      box-shadow: 0 2px 8px #22355c20;
      position: sticky;
      top: 0; z-index: 10;
    }
    header img {
      height: 30px;
      margin-right: 0.5em;
      border-radius: 7px;
      box-shadow: 0 2px 8px #38b6ff15;
      user-select: none;
    }
    header .titlebox {
      flex: 1;
      min-width: 0;
      user-select: none;
    }
    header h1 {
      margin: 0;
      font-size: 1.07rem;
      font-weight: 800;
      color: #fff;
      letter-spacing: 0.01em;
      font-family: var(--font-heading);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-shadow: 0 1px 3px #22355c40;
    }
    main {
      flex: 1 0 auto;
      max-width: 530px;
      margin: 0 auto;
      width: 100%;
      padding: 10px var(--page-padding) 80px var(--page-padding);
      min-height: 0;
      box-sizing: border-box;
      background: none;
    }
    .section {
      display: none;
    }
    .section.active { display: block; animation: fadeInSection 0.18s ease forwards;}
    @keyframes fadeInSection {from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    .card {
      background: var(--card);
      border-radius: 14px;
      box-shadow: 0 2px 9px #c3e6ff17;
      margin-bottom: 0.85em;
      padding: 1em 0.8em 1em 0.8em;
      border: 1px solid #d8eafd;
    }
    .card h3 {
      color: var(--primary2);
      margin: 0 0 0.36em 0;
      font-weight: 800;
      font-size: 1.08em;
      letter-spacing: 0.01em;
      font-family: var(--font-heading);
      user-select: none;
    }
    /* Tables & scroll */
    .table-scroll {
      overflow-x: auto;
      width: 100%;
      border-radius: 7px;
      margin-bottom: 0.15em;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) var(--primary-light);
    }
    .table-scroll::-webkit-scrollbar { height: 6px; }
    .table-scroll::-webkit-scrollbar-track { background: var(--primary-light);}
    .table-scroll::-webkit-scrollbar-thumb { background: var(--accent);}
    table {
      width: 100%;
      background: transparent;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
      font-size: var(--table-font);
      border: none;
      user-select: none;
      letter-spacing: 0.01em;
    }
    th, td {
      padding: 0.5em 0.35em;
      text-align: center;
      font-size: 0.99em;
      border-bottom: 1px solid var(--table-border);
      color: #19223c;
      word-break: break-word;
      white-space: pre-line;
      overflow-wrap: anywhere;
      line-height: 1.13;
    }
    th {color: var(--primary2); font-weight: 800; background: transparent;}
    th:hover {color: var(--accent);}
    .date-heading {
      color: var(--primary2);
      font-size: 0.98em;
      font-weight: 900;
      margin: 1em 0 0.13em 0;
      padding-bottom: 0.11em;
      border-bottom: 2.5px solid var(--accent);
      letter-spacing: 0.01em;
      user-select: none;
    }
    /* Results winner style */
    .result-row.winner1 {border-left: 3px solid var(--accent2);}
    .result-row.winner2 {border-left: 3px solid var(--accent);}
    .winner-cell { font-weight: 800;}
    .winner-icon {font-size: 1.05em;vertical-align:middle;}
    .divider-cell { min-width: 10px; max-width: 10px; padding: 0;}
    .divider-line { width: 2px; height: 24px; background: var(--accent2); border-radius: 1px;}
    /* Standings */
    .stand-row { background: #fff; font-weight: 700; font-size: 0.97em;}
    .stand-row.gold .pos-cell { background: var(--accent2);}
    .stand-row.silver .pos-cell { background: #bfc9da;}
    .stand-row.elim .pos-cell { background: #f55353; color: #fff;}
    .stand-teamlogo { display:none;} /* No logos */
    /* Squads */
    .squad-team-card {
      margin-bottom: 0.6em;
      padding: 0.48em 0.37em;
      border-radius: 10px;
      background: var(--primary-light);
      box-shadow: 0 2px 4px #38b6ff08;
      user-select: none;
      cursor: default;
    }
    .squad-logo-frame {display:none;}
    .squad-team-name { font-weight: 800; font-size: 0.99em; color: var(--primary2);}
    .squad-players { display: flex; flex-wrap: wrap; gap: 6px; justify-content: flex-start;}
    .squad-player-name {
      background: #fff;
      padding: 0.13em 0.36em;
      border-radius: 6px;
      font-size: 0.94em;
      box-shadow: 0 1px 2px #38b6ff08;
      margin-bottom: 1px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      min-width: 67px;
      transition: background-color 0.15s;
      line-height: 1.08;
    }
    .squad-player-name:hover, .squad-player-name:focus {
      background: var(--accent);
      color: #fff;
    }
    #stats-tip {
      font-size: 0.93em;
      color: var(--primary2);
      margin: 0.18em 0 0.5em 0;
      text-align: center;
      background: #e9f3ff;
      border-radius: 7px;
      padding: 3px 7px;
      user-select: none;
    }
    /* Player popup */
    #player-popup {
      display: none;
      position: fixed; left: 0; top: 0;
      width: 100vw; height: 100vh;
      z-index: 250;
      background: rgba(34,53,92,0.92);
      justify-content: center;
      align-items: center;
    }
    #player-popup .popup-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 10px #b1e1ff25;
      padding: 0.95em 1em;
      color: var(--primary-dark);
      min-width: 230px;
      max-width: 95vw;
      text-align: center;
      font-weight: 700;
      font-size: 0.97em;
    }
    #player-popup .popup-head { font-size: 1em; font-weight: 900;}
    #player-popup .popup-team { color: var(--primary2);}
    #player-popup .popup-label { color: var(--primary); font-size: 0.91em; margin-top: 0.11em; text-align: left;}
    #player-popup .popup-close {
      color: #222; font-size: 1.2em;
      background: none; border: none;
      position: absolute; top: 0.6em; right: 0.8em;
      cursor: pointer;
    }
    #save-card-btn {
      margin-top: 0.7em; background: var(--accent); border: none; border-radius: 7px;
      color: #fff; font-weight: 800; font-size: 0.95em; padding: 0.36em 0.9em; cursor: pointer;
    }
    #save-card-btn:hover { background: var(--primary2);}
    /* Footer always at bottom */
    footer {
      width: 100%;
      max-width: 530px;
      margin: 0 auto 0 auto;
      padding: 0.85em 0.7em 0.95em 0.7em;
      background: none;
      color: #7a7a7a;
      font-size: 0.88rem;
      user-select: none;
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 1.0rem;
      box-sizing: border-box;
      flex-shrink: 0;
      position: relative;
    }
    .footer-icons {
      display: flex;
      justify-content: flex-start;
      align-items: center;
      gap: 1.0rem;
      user-select: none;
      flex-shrink: 0;
    }
    .footer-icons img, .footer-icons .wa-btn {
      height: 22px; width: 22px; vertical-align: middle;
      border-radius: 5px; background: #fff; border: 1px solid #bfe4fa;
      object-fit: cover; padding: 2px;
      box-shadow: 0 1px 2px #0002;
      transition: transform 0.14s;
      cursor: pointer;
    }
    .footer-icons img:hover, .footer-icons .wa-btn:hover {
      transform: scale(1.08);
      border-color: var(--accent);
      box-shadow: 0 0 7px var(--accent);
    }
    .wa-btn { background: var(--wa-green); color: #fff !important; border-radius: 8px; font-size: 1.12em; }
    .footer-suca { margin-left: auto; font-style: italic; color: #aaa;}
    /* Navigation bar redesigned mobile-first */
    .nav-bar-glass {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      width: 100vw;
      max-width: 530px;
      z-index: 200;
      background: var(--nav-bg);
      box-shadow: var(--nav-shadow);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px 16px 0 0;
      margin: 0 auto;
      min-height: 50px;
      height: 50px;
      overflow-x: auto;
      overflow-y: hidden;
      user-select: none;
      padding: 0 3px;
      font-family: var(--font-heading);
      border-top: 1px solid #30446f;
    }
    .nav-bar-glass .nav-btn {
      flex: 1 1 0;
      background: none; border: none;
      color: var(--nav-text);
      font-size: 0.98em;
      min-width: 56px; max-width: 70px;
      padding: 0.1em 2px 0.15em 2px;
      text-align: center;
      outline: none;
      position: relative;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      letter-spacing: 0.00em;
      line-height: 1.0;
      transition: color 0.2s;
      border-radius: 10px;
    }
    .nav-bar-glass .nav-btn i {
      font-size: 1.16em;
      margin-bottom: 0.02em;
      transition: color 0.15s;
      line-height: 1.01;
      display: block;
    }
    .nav-bar-glass .nav-label {
      display: block;
      font-size: 0.81em;
      font-weight: 700;
      letter-spacing: 0.00em;
      line-height: 1.08;
      margin-top: -2px;
      opacity: 1;
      white-space: nowrap;
      text-shadow: 0 0 2px #000c;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      max-width: 63px;
      pointer-events: none;
    }
    .nav-bar-glass .nav-btn.active,
    .nav-bar-glass .nav-btn:active {
      color: var(--nav-active);
      font-weight: 800;
      background: #24315e9e;
      text-shadow: 0 0 5px var(--nav-active), 0 0 1px #fff8;
    }
    .nav-bar-glass .nav-btn:focus { outline: 2px solid var(--accent);}
    .nav-bar-glass .nav-indicator {
      display: none;
    }
    @media (max-width: 600px) {
      .nav-bar-glass .nav-label { font-size: 0.79em;}
      .nav-bar-glass .nav-btn { font-size: 0.94em;}
      .nav-bar-glass { min-height: 46px; height: 46px;}
    }
    @media (max-width: 480px) {
      .nav-bar-glass { font-size: 0.95em; }
      .nav-bar-glass .nav-label { font-size: 0.75em;}
      .nav-bar-glass .nav-btn { font-size: 0.91em; min-width: 47px;}
    }
    @media (max-width: 380px) {
      .nav-bar-glass { font-size: 0.91em;}
      .nav-bar-glass .nav-label { font-size: 0.68em; }
      .nav-bar-glass .nav-btn { font-size: 0.88em;}
    }
    /* Comparison selects */
    #compare .player-select-container {
      max-width: 420px;
      margin: 0 auto 0.8em auto;
      display: flex;
      gap: 0.36em;
      flex-wrap: wrap;
      justify-content: flex-start;
    }
    #compare select {
      flex: 1 1 110px;
      padding: 0.30em 0.37em;
      font-size: 0.97em;
      border-radius: 6px;
      border: 1px solid var(--table-border);
      min-width: 100px;
      max-width: 100%;
      background: #fff;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      box-sizing: border-box;
    }
    #compare select:disabled { color: #aaa;}
    #compare .compare-btn {
      margin-top: 0.38em;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 7px;
      font-weight: 800;
      font-size: 0.98em;
      padding: 0.33em 0.75em;
      cursor: pointer;
      min-width: 105px;
      transition: background-color 0.18s;
    }
    #compare .compare-btn:disabled {background: #b2d9fc99; color: #fff;}
    #compare .compare-btn:hover:not(:disabled) {background: var(--primary2);}
    #compare-results {margin-top: 1em; overflow-x: auto;}
    #compare-results table {
      width: 100%;
      min-width: 340px;
      border-collapse: collapse;
      font-size: 0.94em;
      margin-bottom: 0.4em;
    }
    #compare-results th, #compare-results td {
      border: 1px solid var(--table-border);
      padding: 0.35em 0.45em;
      text-align: center;
      vertical-align: middle;
      user-select: text;
      font-size: 0.95em;
    }
    #compare-results th.metric-header {
      background: var(--accent);
      color: #fff;
      text-align: left;
      font-weight: 800;
      min-width: 80px;
      font-size: 0.96em;
    }
    #compare-results td.player-name-cell {
      font-weight: 700;
      color: var(--primary2);
      background: #e9f3ff;
      min-width: 90px;
      font-size: 0.96em;
    }
    #compare-results td.player-logo {display: none;}
    #compare-results tbody tr:nth-child(even) {background: #f7fbff;}
    /* Responsive bottom spacing */
    @media (max-width: 520px) {
      main { padding-bottom: 80px; }
      #compare-results table { font-size: 0.9em;}
    }
    /* Bottom page padding so last row visible */
    .pad-for-nav { height: 58px; min-height: 58px; display: block; width: 100%;}
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Royal Darts Premier League Logo" draggable="false"/>
    <div class="titlebox">
      <h1>Royal Darts Premier League 2025</h1>
    </div>
  </header>
  <main>
    <!-- Dashboard -->
    <section id="dashboard" class="section active" aria-label="Dashboard Home">
      <div class="card">
        <h3>Today's Fixtures</h3>
        <div class="table-scroll">
          <table class="fixtures-table" id="dashboard-fixtures-table" role="table" aria-live="polite" aria-atomic="true">
            <thead>
              <tr>
                <th scope="col">Time</th>
                <th scope="col">Team 1</th>
                <th scope="col"></th>
                <th scope="col">Team 2</th>
              </tr>
            </thead>
            <tbody id="dashboard-fixtures"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:-0.6em;">
        <h3>Quick Standings</h3>
        <div class="standings-group-title" aria-hidden="true">Group A</div>
        <div class="table-scroll" role="table" aria-live="polite" aria-atomic="true">
          <table class="standings-table" role="grid">
            <thead>
              <tr><th scope="col">Pos</th><th scope="col">Team</th><th scope="col">Pts</th></tr>
            </thead>
            <tbody id="dashboard-standings-a"></tbody>
          </table>
        </div>
        <div class="standings-group-title" aria-hidden="true" style="margin-top:0.4em;">Group B</div>
        <div class="table-scroll" role="table" aria-live="polite" aria-atomic="true">
          <table class="standings-table" role="grid">
            <thead>
              <tr><th scope="col">Pos</th><th scope="col">Team</th><th scope="col">Pts</th></tr>
            </thead>
            <tbody id="dashboard-standings-b"></tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- Fixtures -->
    <section id="fixtures" class="section" aria-label="Fixtures">
      <div class="card">
        <h3>Fixtures</h3>
        <div id="fixturesTableContainer"></div>
      </div>
    </section>
    <!-- Results -->
    <section id="results" class="section" aria-label="Results">
      <div class="card">
        <h3>Results</h3>
        <div id="resultsContainer"></div>
      </div>
    </section>
    <!-- Standings -->
    <section id="standings" class="section" aria-label="Standings">
      <div class="card" style="margin-bottom:0.6em;">
        <div class="stand-legend" aria-hidden="true">
          <span class="gold" title="Gold Cup (Top 3)">Gold Cup</span>
          <span class="silver" title="Silver Cup (4-6)">Silver Cup</span>
          <span class="elim" title="Eliminated (7-8)">Eliminated</span>
        </div>
        <h3>Standings</h3>
        <div class="standings-group-title" aria-hidden="true">Group A</div>
        <div id="standings-a" role="table" aria-live="polite" aria-atomic="true"></div>
        <div class="standings-group-title" aria-hidden="true" style="margin-top:1em;">Group B</div>
        <div id="standings-b" role="table" aria-live="polite" aria-atomic="true"></div>
      </div>
    </section>
    <!-- Squads -->
    <section id="squads" class="section" aria-label="Squads">
      <div class="card">
        <h3>Squads</h3>
        <div id="squadsContainer" class="squad-grid"></div>
      </div>
    </section>
    <!-- Stats -->
    <section id="stats" class="section" aria-label="Player Stats">
      <div class="card">
        <h3>Player Stats</h3>
        <div id="stats-tip">Tip: Tap any player name in the table below to view and save their full player card.</div>
        <div id="stat-highlights"></div>
        <div class="team-filter-bar" id="team-filter-bar"></div>
        <input id="stats-search" type="text" placeholder="Search player or team..." aria-label="Search player or team" style="margin-bottom:0.4em;padding:0.18em 0.35em;font-size:0.93em;width:96vw;max-width:140px;border-radius:5px;border:1px solid var(--table-border);display:block;margin:auto;">
        <div id="stats-table"></div>
      </div>
    </section>
    <!-- Live -->
    <section id="live" class="section" aria-label="Live Stream">
      <div class="card">
        <h3>Watch Live</h3>
        <iframe src="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" width="100%" height="320" frameborder="0" style="border-radius:9px;border:none;" title="Live tournament stream"></iframe>
      </div>
    </section>
    <!-- Compare -->
    <section id="compare" class="section" aria-label="Player Comparison">
      <div class="card">
        <h3>Player Comparison</h3>
        <p class="compare-instruction" id="compare-instruction" style="font-size:0.98em;margin-bottom:0.45em;">Select two or more players to compare their stats side-by-side.</p>
        <div class="player-select-container" role="group" aria-labelledby="compare-instruction"></div>
        <button id="compare-btn" class="compare-btn" disabled aria-disabled="true" aria-describedby="compare-instruction">Compare Players</button>
        <div id="compare-results"></div>
      </div>
    </section>
    <div class="pad-for-nav"></div>
  </main>
  <!-- NAVIGATION BAR -->
  <nav class="nav-bar-glass" role="navigation" aria-label="Main Navigation">
    <button class="nav-btn active" data-tab="dashboard" title="Home" aria-current="page" aria-label="Go to Home">
      <i class="lucide lucide-home" aria-hidden="true"></i><span class="nav-label">Home</span>
    </button>
    <button class="nav-btn" data-tab="fixtures" title="Fixtures" aria-label="Go to Fixtures">
      <i class="lucide lucide-calendar-days" aria-hidden="true"></i><span class="nav-label">Fixtures</span>
    </button>
    <button class="nav-btn" data-tab="results" title="Results" aria-label="Go to Results">
      <i class="lucide lucide-list-start" aria-hidden="true"></i><span class="nav-label">Results</span>
    </button>
    <button class="nav-btn" data-tab="standings" title="Standings" aria-label="Go to Standings">
      <i class="lucide lucide-trophy" aria-hidden="true"></i><span class="nav-label">Standings</span>
    </button>
    <button class="nav-btn" data-tab="squads" title="Squads" aria-label="Go to Squads">
      <i class="lucide lucide-users" aria-hidden="true"></i><span class="nav-label">Squads</span>
    </button>
    <button class="nav-btn" data-tab="stats" title="Stats" aria-label="Go to Player Stats">
      <i class="lucide lucide-bar-chart" aria-hidden="true"></i><span class="nav-label">Stats</span>
    </button>
    <button class="nav-btn" data-tab="live" title="Live" aria-label="Go to Live Stream">
      <i class="lucide lucide-play-circle" aria-hidden="true"></i><span class="nav-label">Live</span>
    </button>
    <button class="nav-btn" data-tab="compare" title="Compare Players" aria-label="Go to Player Comparison">
      <i class="lucide lucide-columns" aria-hidden="true"></i><span class="nav-label">Compare</span>
    </button>
  </nav>
  <!-- Player popup -->
  <div id="player-popup" onclick="hidePlayerPopup(event)" role="dialog" aria-modal="true" aria-hidden="true" aria-labelledby="player-popup-head" tabindex="-1">
    <div class="popup-card" role="document"></div>
    <button class="popup-close" onclick="hidePlayerPopup(event)" aria-label="Close player card">&times;</button>
  </div>
  <!-- Footer always at bottom -->
  <footer>
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank" rel="noopener" aria-label="Watch live on Nakka">
        <img src="https://n01darts.com/favicon.ico" alt="Nakka" draggable="false" />
      </a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank" rel="noopener" aria-label="Follow Royal Darts on Instagram">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" draggable="false" />
      </a>
      <a href="#" class="wa-btn" id="wa-share-btn" title="Share on WhatsApp" aria-label="Share on WhatsApp">
        <span class="lucide lucide-message-circle" aria-hidden="true"></span>
      </a>
    </div>
    <div class="footer-suca" aria-hidden="true">Built by SUCA Analytics</div>
  </footer>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <script defer>
    const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';
    let fixturesCache = [], standingsCache = [], statsCache = [], bestLegCache = [], squadsCache = [], resultsCache = [];
    let statsSortKey = null, statsSortDir = 1, statsSearchTerm = "", teamFilter = null;
    const STATS_HIDE_COLUMNS = new Set(["Keep", "Break", "Second Legs", "Break Legs", "Total Score", "Total Darts", "Group", "Best Leg", "Worst Leg"]);
    function curlText(txt) {
      if (!txt) return '';
      if (txt.length <= 15) return txt;
      let lastSpace = txt.lastIndexOf(' ', 15);
      if (lastSpace < 0 || lastSpace > txt.length-4) return txt;
      return txt.slice(0, lastSpace) + "\n" + txt.slice(lastSpace+1);
    }
    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.nav-bar-glass .nav-btn').forEach(btn => btn.classList.remove('active'));
      const activeSection = document.getElementById(tabId);
      if (activeSection) activeSection.classList.add('active');
      document.querySelectorAll('.nav-bar-glass .nav-btn').forEach(btn => {
        if (btn.getAttribute('data-tab') === tabId) {
          btn.classList.add('active');
          btn.setAttribute('aria-current', 'page');
        } else { btn.removeAttribute('aria-current'); }
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function setupWhatsAppShare() {
      const waBtn = document.getElementById("wa-share-btn");
      if (waBtn) {
        waBtn.addEventListener("click", function(e) {
          e.preventDefault();
          const shareUrl = window.location.href.split('?')[0];
          const msg = encodeURIComponent("Check out the Royal Darts Premier League 2025 – live results, fixtures, stats and more! " + shareUrl);
          window.open(`https://wa.me/?text=${msg}`, "_blank");
        });
      }
    }
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        standingsCache = data.Standings || [];
        statsCache = (data.Stats || []).filter(row => row.Player);
        bestLegCache = (data["Best Leg"] || []).filter(row => row["Best Leg"]);
        squadsCache = data.Squads || [];
        resultsCache = data.Results || [];
        renderDashboardFixtures(); renderDashboardStandingsTables();
        renderFixtures(fixturesCache); renderResults(resultsCache, fixturesCache);
        renderStandingsTables(); renderSquads(squadsCache);
        renderStatHighlights(statsCache, bestLegCache, "stat-highlights");
        renderStats(statsCache, bestLegCache); renderTeamFilter(statsCache);
        renderPlayerComparisonSelectors();
      } catch (err) { console.error('Failed to load data:', err);}
    }
    function renderDashboardFixtures() {
      const now = new Date();
      const istNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
      const istYear = istNow.getFullYear(), istMonth = istNow.getMonth(), istDate = istNow.getDate();
      function isISTToday(d) {
        const istD = new Date(new Date(d).toLocaleString("en-US", {timeZone: "Asia/Kolkata"}));
        return (istD.getFullYear() === istYear && istD.getMonth() === istMonth && istD.getDate() === istDate);
      }
      const todaysFixtures = fixturesCache.filter(fix => isISTToday(fix.Date));
      let html = '';
      if (!todaysFixtures.length) {
        html = `<tr><td colspan="4" style="color:var(--primary);">No fixtures today.</td></tr>`;
      } else {
        todaysFixtures.forEach(f => {
          const timeStr = new Date(f.Time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'});
          html += `<tr>
            <td>${timeStr}</td>
            <td class="curl">${curlText(f['Team 1']) || ""}</td>
            <td></td>
            <td class="curl">${curlText(f['Team 2']) || ""}</td>
          </tr>`;
        });
      }
      document.getElementById('dashboard-fixtures').innerHTML = html;
    }
    function renderDashboardStandingsTables() {
      const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points - a.Points || b.LD - a.LD);
      const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points - a.Points || b.LD - a.LD);
      document.getElementById('dashboard-standings-a').innerHTML = quickStandingsRows(A);
      document.getElementById('dashboard-standings-b').innerHTML = quickStandingsRows(B);
    }
    function quickStandingsRows(arr) {
      return arr.map((s,i) => {
        let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
        return `<tr class="stand-row ${groupClass}">
          <td class="pos-cell">${i+1}</td>
          <td class="curl" style="text-align:center;">${curlText(s.Team)}</td>
          <td class="stand-points" style="text-align:center;">${s.Points}</td>
        </tr>`;
      }).join('');
    }
    function renderFixtures(fixtures) {
      const container = document.getElementById('fixturesTableContainer');
      if (!fixtures.length) {
        container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
        return;
      }
      const byDate = {};
      fixtures.forEach(f => {
        const d = new Date(f.Date).toDateString();
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(f);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll">
        <table class="fixtures-table" role="table" aria-label="Fixtures for ${dateStr}">
          <thead>
            <tr><th scope="col">Time</th><th scope="col">Team 1</th><th scope="col"></th><th scope="col">Team 2</th></tr>
          </thead>
          <tbody>`;
        byDate[dateStr].forEach(f => {
          html += `<tr>
              <td>${new Date(f.Time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td class="curl">${curlText(f['Team 1'] || "")}</td>
              <td></td>
              <td class="curl">${curlText(f['Team 2'] || "")}</td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      container.innerHTML = html;
    }
    function renderResults(results, fixtures) {
      const fixtureDateMap = {};
      fixtures.forEach(fix => {
        const t1 = fix["Team 1"], t2 = fix["Team 2"];
        const dateStr = new Date(fix.Date).toDateString();
        fixtureDateMap[`${t1}|${t2}`] = dateStr;
        fixtureDateMap[`${t2}|${t1}`] = dateStr;
      });
      const byDate = {};
      results.forEach(r => {
        let dateVal = "";
        if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
          dateVal = new Date(r.Date).toDateString();
        } else {
          const t1 = r["Team 1"], t2 = r["Team 2"];
          dateVal = fixtureDateMap[`${t1}|${t2}`] || fixtureDateMap[`${t2}|${t1}`] || "Unknown Date";
        }
        if (!byDate[dateVal]) byDate[dateVal] = [];
        byDate[dateVal].push(r);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll" role="table">
          <table class="results-table" role="grid">
            <thead>
              <tr>
                <th scope="col">Avg 1</th>
                <th scope="col">Team 1</th>
                <th scope="col">Score</th>
                <th scope="col" class="divider-cell"></th>
                <th scope="col">Score</th>
                <th scope="col">Team 2</th>
                <th scope="col">Avg 2</th>
              </tr>
            </thead>
            <tbody>`;
        byDate[dateStr].forEach(r => {
          const win1 = +r['Legs 1'] > +r['Legs 2'];
          const win2 = +r['Legs 2'] > +r['Legs 1'];
          let rowClass = win1 ? "winner1" : win2 ? "winner2" : "";
          html += `<tr class="result-row ${rowClass}">
            <td>${r['Avg 1']||""}</td>
            <td class="curl${win1?" winner-cell":""}" style="text-align:center;">${curlText(r['Team 1']||"")}${win1?' <span class="winner-icon">🏆</span>':''}</td>
            <td style="text-align:center;"${win1?' class="winner-cell"':''}>${r['Legs 1']==0?"0":r['Legs 1']||"0"}</td>
            <td class="divider-cell"><div class="divider-line"></div></td>
            <td style="text-align:center;"${win2?' class="winner-cell"':''}>${r['Legs 2']==0?"0":r['Legs 2']||"0"}</td>
            <td class="curl${win2?" winner-cell":""}" style="text-align:center;">${curlText(r['Team 2']||"")}${win2?' <span class="winner-icon">🏆</span>':''}</td>
            <td>${r['Avg 2']||""}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      document.getElementById('resultsContainer').innerHTML = html || '';
    }
    function renderStandingsTables() {
      const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points - a.Points || b.LD - a.LD);
      const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points - a.Points || b.LD - a.LD);
      document.getElementById('standings-a').innerHTML = standingsTable(A);
      document.getElementById('standings-b').innerHTML = standingsTable(B);
    }
    function standingsTable(arr) {
      let html = `<div class="table-scroll"><table class="standings-table" role="grid"><thead>
        <tr>
          <th scope="col">Pos</th>
          <th scope="col">Team</th>
          <th scope="col">P</th>
          <th scope="col">W</th>
          <th scope="col">L</th>
          <th scope="col">EF</th>
          <th scope="col">EA</th>
          <th scope="col">ED</th>
          <th scope="col">Pts</th>
          <th scope="col">Avg</th>
        </tr>
      </thead><tbody>`;
      arr.forEach((s,i) => {
        let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
        html += `<tr class="stand-row ${groupClass}">
          <td class="pos-cell">${i+1}</td>
          <td class="curl" style="text-align:center;">${curlText(s.Team)}</td>
          <td style="text-align:center;">${s.P}</td>
          <td style="text-align:center;">${s.W}</td>
          <td style="text-align:center;">${s.L}</td>
          <td style="text-align:center;">${s.LF||0}</td>
          <td style="text-align:center;">${s.LA||0}</td>
          <td style="text-align:center;">${s.LD||0}</td>
          <td class="stand-points" style="text-align:center;">${s.Points}</td>
          <td style="text-align:center;">${s.Avg}</td>
        </tr>`;
      });
      html += "</tbody></table></div>";
      return html;
    }
    function renderSquads(squads) {
      const container = document.getElementById('squadsContainer');
      if (!squads.length) { container.innerHTML = 'Loading...'; return; }
      const teams = [...new Set(squads.map(s => s.Team))];
      let html = '';
      teams.forEach(team => {
        const players = squads.filter(s => s.Team === team).map(p =>
          `<div class="squad-player-name curl" tabindex="0" role="button" aria-pressed="false" onclick="showPlayerPopup('${p.Player.replace(/'/g,"\\'")}')" onkeydown="if(event.key==='Enter'||event.key===' ') {event.preventDefault(); showPlayerPopup('${p.Player.replace(/'/g,"\\'")}');}">
            ${curlText(p.Player)}
          </div>`
        ).join('');
        html += `<div class="squad-team-card" role="region" aria-label="Team ${team}">
          <div class="squad-team-name curl">${curlText(team)}</div>
          <div class="squad-players">${players}</div>
        </div>`;
      });
      container.innerHTML = html;
    }
    function renderStatHighlights(stats, bestLegsSheet, id="stat-highlights") {
      document.getElementById(id).innerHTML = "";
    }
    function renderTeamFilter(stats) {
      const bar = document.getElementById('team-filter-bar');
      if (!stats || !stats.length) { bar.innerHTML = ''; return;}
      const allTeams = Array.from(new Set(stats.map(p => p.Team).filter(Boolean))).sort();
      let html = `<select class="team-filter-dropdown" onchange="setTeamFilter(this.value)" aria-label="Filter stats by team">
        <option value="">All Teams</option>`;
      allTeams.forEach(team => {
        html += `<option value="${team.replace(/"/g, "&quot;")}"${teamFilter===team?" selected":""}>${team}</option>`;
      });
      html += `</select>`;
      bar.innerHTML = html;
    }
    window.setTeamFilter = function(team) {
      teamFilter = team || null;
      renderStats(statsCache, bestLegCache);
    };
    // --- New mobile-first Stats Table ---
    function getBestStats(stats, keys) {
      let bests = {};
      keys.forEach(key => {
        let valArr = stats.map(p => Number(p[key])).filter(x => !isNaN(x));
        if (!valArr.length) return;
        let max = Math.max(...valArr);
        bests[key] = max;
      });
      return bests;
    }
    function renderStats(stats, bestLegsSheet) {
      const mainStats = ["Player", "Team", "3 Dart Avg", "Legs Won", "Match Played"];
      const extraStats = [
        "First 9 Avg", "Sets Played", "Sets Won", "Sets Lost", "Legs Played",
        "Legs Lost", "Win Rate (Sets)", "Win Rate (Legs)", "High Finish",
        "Checkout %", "180s", "100+", "Best Leg", "High Checkout"
      ];
      const bests = getBestStats(stats, ["3 Dart Avg", "Legs Won"]);
      let html = `<table class="stats-table-modern" role="grid">
        <thead>
          <tr>
            <th>Player</th>
            <th>Team</th>
            <th title="3 Dart Average">3DA</th>
            <th title="Legs Won">Legs</th>
            <th title="Matches Played">M</th>
            <th style="text-align:center;">More</th>
          </tr>
        </thead>
        <tbody>
      `;
      stats.forEach((row, i) => {
        const isAlt = i%2!==0 ? "alt-row" : "";
        const best3DA = Number(row["3 Dart Avg"]) === bests["3 Dart Avg"] && bests["3 Dart Avg"] > 0;
        const bestLegs = Number(row["Legs Won"]) === bests["Legs Won"] && bests["Legs Won"] > 0;
        html += `<tr class="${isAlt}">
          <td class="stats-player${best3DA ? ' stats-best' : ''}">
            ${best3DA ? '<span class="star" title="Best 3DA">★</span>':''}
            ${row.Player ? row.Player : ""}
          </td>
          <td class="stats-team">${row.Team ? row.Team : ""}</td>
          <td${best3DA ? ' class="stats-best"' : ''}>${row["3 Dart Avg"] ?? "-"}</td>
          <td${bestLegs ? ' class="stats-best"' : ''}>${bestLegs ? '<span class="trophy" title="Most Legs Won">🏆</span>' : ''}${row["Legs Won"] ?? "-"}</td>
          <td>${row["Match Played"] ?? "-"}</td>
          <td style="text-align:center;">
            <button class="show-more-btn" onclick="toggleExtraStats(this, ${i})" tabindex="0" aria-label="Show more stats for ${row.Player}">More</button>
          </td>
        </tr>
        <tr class="extra-stats-row" id="extra-stats-${i}" style="display:none;">
          <td colspan="6">
            <div style="display:flex;flex-wrap:wrap;gap:0.5em 1.3em;align-items:flex-start;">
              ${extraStats.map(k => row[k] !== undefined && row[k] !== "" ?
                `<span>
                  <span class="extra-stats-label">${k}:</span>
                  <span class="extra-stats-value">${k.includes("Win Rate") ? (!isNaN(row[k]) ? Math.round(parseFloat(row[k])*100)+'%' : '-') : row[k]}</span>
                </span>` : ''
              ).join("")}
            </div>
          </td>
        </tr>
        `;
      });
      html += `</tbody></table>`;
      document.getElementById("stats-table").innerHTML = html;
    }
    window.toggleExtraStats = function(btn, idx) {
      const row = document.getElementById("extra-stats-"+idx);
      if (!row) return;
      if (row.style.display === "none") {
        row.style.display = "";
        btn.innerText = "Less";
      } else {
        row.style.display = "none";
        btn.innerText = "More";
      }
    };
    function showPlayerPopup(playerName) {
      let p = statsCache.find(s => s.Player === playerName);
      if (!p) return;
      let card = `<div id="player-popup-head" class="popup-head">${curlText(p.Player)}</div>
        <div class="popup-team">${curlText(p.Team||"")}</div>
        <div style="color:var(--primary);font-size:1em;font-weight:700;margin-bottom:0.15em;">Stats</div>
        ${Object.keys(p).map(h => {
          if (["Player", "Team"].includes(h) || STATS_HIDE_COLUMNS.has(h) || !p[h]) return "";
          return `<div class="popup-label"><span style="color:var(--accent);font-weight:600;">${h}:</span> ${p[h]}</div>`;
        }).join("")}
        <button id="save-card-btn" onclick="savePlayerCard(event)" aria-label="Save player card as image">Save Card as Image</button>`;
      document.querySelector("#player-popup .popup-card").innerHTML = card;
      const popup = document.getElementById("player-popup");
      popup.style.display = "flex";
      popup.setAttribute("aria-hidden", "false");
      popup.focus();
    }
    window.savePlayerCard = function(e) {
      e.stopPropagation();
      let cardNode = document.querySelector("#player-popup .popup-card");
      html2canvas(cardNode, {backgroundColor: "#fff", scale: 2}).then(function(canvas){
        let link = document.createElement("a");
        link.download = "Player-Card.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    };
    function hidePlayerPopup(e) {
      if (!e || !e.target || e.target.id === "player-popup" || e.target.classList.contains("popup-close")) {
        const popup = document.getElementById("player-popup");
        popup.style.display = "none";
        popup.setAttribute("aria-hidden", "true");
      }
    }
    function renderPlayerComparisonSelectors() {
      const container = document.querySelector("#compare .player-select-container");
      if (!container || !statsCache.length) return;
      container.innerHTML = "";
      const NUM_SELECTS = 4;
      const uniquePlayers = Array.from(new Set(statsCache.map(p => p.Player))).sort((a,b) => a.localeCompare(b));
      for(let i=0; i<NUM_SELECTS; i++) {
        const select = document.createElement("select");
        select.setAttribute("aria-label", `Select player ${i+1}`);
        select.dataset.idx = i;
        const optionDefault = document.createElement("option");
        optionDefault.value = "";
        optionDefault.textContent = i < 2 ? `Select player ${i+1} (required)` : `Select player ${i+1} (optional)`;
        optionDefault.disabled = (i < 2);
        optionDefault.selected = true;
        select.appendChild(optionDefault);
        uniquePlayers.forEach(player => {
          const opt = document.createElement("option");
          opt.value = player;
          opt.textContent = player;
          select.appendChild(opt);
        });
        container.appendChild(select);
      }
      container.querySelectorAll("select").forEach(sel => {
        sel.addEventListener("change", updateCompareButtonState);
      });
      document.getElementById("compare-results").innerHTML = "";
      updateCompareButtonState();
    }
    function updateCompareButtonState() {
      const selects = document.querySelectorAll("#compare .player-select-container select");
      const selectedValues = Array.from(selects).map(s => s.value).filter(v => v);
      const compareBtn = document.getElementById("compare-btn");
      const uniquePlayers = [...new Set(selectedValues)];
      if (uniquePlayers.length >= 2) {
        compareBtn.disabled = false;
        compareBtn.setAttribute("aria-disabled", "false");
      } else {
        compareBtn.disabled = true;
        compareBtn.setAttribute("aria-disabled", "true");
      }
    }
    function renderPlayerComparison() {
      const selects = document.querySelectorAll("#compare .player-select-container select");
      const selectedPlayers = Array.from(selects).map(s => s.value).filter(v => v);
      const uniquePlayers = [...new Set(selectedPlayers)];
      if (uniquePlayers.length < 2) {
        alert("Please select at least two different players to compare.");
        return;
      }
      const container = document.getElementById("compare-results");
      container.innerHTML = "";
      const keysToShow = [
        "Match Played", "Sets Played", "Sets Won", "Sets Lost", "Win Rate (Sets)",
        "Legs Played", "Legs Won", "Legs Lost", "Win Rate (Legs)",
        "3 Dart Avg", "First 9 Avg", "High Finish", "Checkout %",
        "180s", "100+", "Best Leg", "High Checkout"
      ];
      let thead = "<tr><th class='metric-header' scope='col'>Metric</th>";
      uniquePlayers.forEach(playerName => {
        thead += `<th class="player-name-cell" scope="col" title="${playerName}">${playerName}</th>`;
      });
      thead += "</tr>";
      let tbody = "";
      keysToShow.forEach(metric => {
        tbody += `<tr><th class="metric-header" scope="row">${metric}</th>`;
        uniquePlayers.forEach(playerName => {
          const playerData = statsCache.find(p => p.Player === playerName);
          let val = (playerData && (playerData[metric]!==undefined && playerData[metric]!==null && playerData[metric]!=='')) ? playerData[metric] : "0";
          if (metric.includes("Win Rate") && val !== "—") {
            val = isNaN(parseFloat(val)) ? "—" : `${Math.round(parseFloat(val)*100)}%`;
          }
          if (val === "" || val === undefined || val === null) val = "0";
          tbody += `<td>${val}</td>`;
        });
        tbody += "</tr>";
      });
      const tableHtml = `<table aria-label="Player comparison table">
        <thead>${thead}</thead>
        <tbody>${tbody}</tbody>
      </table>`;
      container.innerHTML = tableHtml;
      window.scrollTo({top:0, behavior:'smooth'});
    }
    document.addEventListener("DOMContentLoaded", function() {
      document.querySelectorAll('.nav-bar-glass .nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const tab = this.getAttribute('data-tab');
          showTab(tab);
        });
      });
      setupWhatsAppShare();
      document.getElementById("compare-btn").addEventListener("click", renderPlayerComparison);
      loadData();
      setInterval(loadData, 60000);
    });
  </script>
</body>
</html>
