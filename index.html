<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Royal Darts Premier League 2025</title>
  <meta name="theme-color" content="#171e30">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/174/174855.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.322.0/font/lucide.css"/>
  <style>
    :root {
      --primary: #171e30;
      --primary2: #22355c;
      --primary-light: #e9f3ff;
      --accent: #38b6ff;
      --accent2: #ffc93a;
      --gold: #ffc93a;
      --silver: #bfc9da;
      --eliminated: #f55353;
      --card: #fff;
      --glass-bg: rgba(255,255,255,0.23);
      --glass-border: rgba(56,182,255,0.10);
      --nav-bg: rgba(23,30,48,0.85);
      --nav-glass: rgba(34,53,92,0.72);
      --shadow: 0 4px 32px 0 rgba(56,182,255,0.14);
      --table-border: #e2ecf4;
      --text: #1d253c;
    }
    html, body {
      background: #f7fafd;
      color: var(--text);
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0; min-height: 100%;
      overscroll-behavior-y: none;
    }
    header {
      background: linear-gradient(120deg, var(--primary2) 80%, var(--accent) 120%);
      color: #fff;
      padding: 1.08rem 0.5rem 1.08rem 0.5rem;
      text-align: left;
      display: flex; align-items: center; gap: 0.8em;
      border-bottom: 1.5px solid #b2d9fc;
      box-shadow: 0 3px 30px #22355c0b;
    }
    header img { height: 44px; margin-right: 0.65em; border-radius: 9px; box-shadow: 0 2px 8px #38b6ff11; }
    header .titlebox { flex:1;}
    header h1 {margin: 0; font-size: 1.15em; font-weight: 800; color: #fff; line-height: 1.09;}
    main { max-width: 540px; margin: 0 auto 88px auto; padding: 1rem 0.14rem 0.1rem 0.14rem; }
    .section { display: none; }
    .section.active { display: block; }
    .card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: 0 4px 28px #c3e6ff17;
      margin-bottom: 1.19em;
      padding: 1.09em 0.85em 1.05em 0.85em;
    }
    .card h3 {
      color: var(--primary2); margin: 0 0 0.32em 0;
      font-weight: 900; font-size:1.08em; letter-spacing:0.01em;
    }
    .table-scroll {
      overflow-x: auto;
      width: 100%;
      border-radius: 12px;
      margin-bottom: 0.25em;
    }
    table {
      width: 100%; background: transparent;
      border-collapse: separate; border-spacing: 0; margin: 0;
      font-size: 1em; border: none;
    }
    th,td {
      padding: 0.61em 0.25em;
      text-align: center;
      font-size: 1.08em;
      border-bottom: 1px solid var(--table-border);
      background: transparent;
      color: var(--text);
      word-break: break-word; white-space: pre-line; overflow-wrap: anywhere; line-height: 1.18;
    }
    th { color: var(--primary2); font-weight:800; background:transparent; border-bottom:2px solid #b2d9fc;}
    .curl { white-space: pre-line; word-break: break-word; }
    .divider-cell { min-width:16px;max-width:16px;padding:0;text-align:center;vertical-align:middle;}
    .divider-line { width:2px; height:34px; background:var(--accent2); margin:0 auto; border-radius:2px; display:inline-block;}
    /* Standings */
    .stand-row {
      background: #fff; border-radius: 8px; font-weight: 700;
      font-size: 1.08em; margin-bottom: 0.10em; position:relative; box-shadow: 0 2px 14px #38b6ff09; text-align: center;
      border-left: 7px solid transparent; transition:box-shadow 0.12s;
    }
    .stand-row.gold {border-left: 7px solid var(--gold);}
    .stand-row.silver {border-left: 7px solid var(--silver);}
    .stand-row.elim {border-left: 7px solid var(--eliminated);}
    .stand-badge { font-size: 0.93em; vertical-align: middle; margin-left: 6px;}
    .stand-teamlogo { width: 20px; height: 20px; border-radius: 4px; vertical-align: middle; margin-right: 7px;}
    .stand-points {font-weight:800; font-size:1.03em;}
    /* Standings legend */
    .stand-legend {text-align:center;font-size:0.95em;margin-bottom:0.7em;}
    .stand-legend span {display:inline-block;border-radius:4px;padding:2px 9px;margin:0 5px;font-weight:700;}
    .stand-legend .gold {background:var(--gold);color:#2e2e2e;}
    .stand-legend .silver {background:var(--silver);color:#232323;}
    .stand-legend .elim {background:#ffdbdb;color:#99111c;}
    /* Results */
    .result-winner {
      background: var(--primary-light) !important;
      font-weight: 800 !important;
      border-radius: 5px;
      color: var(--accent2) !important;
      box-shadow: 0 1px 5px #ffc93a22;
      position: relative;
      z-index: 2;
    }
    tr.result-row { box-shadow: 0 3px 19px #38b6ff10;}
    /* Fixtures */
    .date-heading {
      color: var(--primary2);
      font-size: 1.22em;
      font-weight: 900;
      margin: 1.3em 0 0.12em 0;
      padding-bottom: 0.14em;
      border-bottom: 3.5px solid var(--accent);
      letter-spacing: 0.01em;
    }
    /* Stats */
    #stats-table th, #stats-table td { min-width: 74px; max-width: 108px;}
    #stats-table td.stat-player, #stats-table td.stat-team { white-space:pre-line; word-break:break-word; line-height:1.13; cursor:pointer;}
    #stats-table td.stat-team img {width:12px;height:12px;vertical-align:middle;margin-right:2px;}
    /* Player popup */
    #player-popup { display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:250;
      background:rgba(34,53,92,0.92); justify-content:center; align-items:center;
      animation:fadeIn 0.14s; }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    #player-popup .popup-card { background:#fff; border-radius:12px; box-shadow:0 2px 14px #b1e1ff33;
      padding:1em 1.1em; color:var(--primary-dark); min-width:130px;max-width:93vw; text-align:center; font-weight:700;}
    #player-popup .popup-head {font-size:1.08em; font-weight:800; margin-bottom:0.18em;}
    #player-popup .popup-team {color:var(--primary-dark);font-weight:700;margin-bottom:0.18em;}
    #player-popup .popup-label {color:#212b36;font-size:0.92em;margin-top:0.11em;}
    #player-popup .popup-close {color:#222; font-size:1.2em; background:none; border:none; position:absolute;top:1.1em;right:1.1em;cursor:pointer;}
    /* Squads premium card grid */
    .squad-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(168px,1fr)); gap:1.13em; }
    .squad-team-card {
      background: var(--glass-bg); backdrop-filter: blur(11px);
      border: 2px solid var(--glass-border);
      border-radius: 19px;
      padding: 1.09em 0.6em 0.86em 0.6em;
      text-align: center;
      box-shadow: var(--shadow);
      transition: transform 0.15s, box-shadow 0.15s;
      position: relative;
    }
    .squad-team-card:hover { transform: translateY(-2px) scale(1.025); box-shadow: 0 6px 22px #38b6ff23; }
    .squad-logo-frame {
      display: flex; align-items: center; justify-content: center;
      background: linear-gradient(120deg,var(--accent) 50%,var(--primary2) 100%);
      border-radius: 50%; width: 56px; height: 56px; margin: 0 auto 0.44em auto;
      box-shadow: 0 2px 14px #38b6ff22;
      border: 4px solid #fff;
    }
    .squad-logo-frame img { width: 37px; height: 37px; object-fit: contain; border-radius: 50%; background: #fff;}
    .squad-team-name { font-size: 1.1em; font-weight: 900; color: var(--primary2); margin-bottom: 0.44em; }
    .squad-players { display: flex; flex-direction: column; gap: 0.21em; }
    .squad-player-name {
      background: rgba(56,182,255,0.06);
      color: var(--text);
      border-radius: 6px; padding: 3px 0;
      margin: 0 0 0 0;
      font-size: 1em;
      transition: background 0.16s;
      font-weight: 600;
      cursor: pointer;
    }
    .squad-player-name:active, .squad-player-name:focus { background: var(--accent); color: #fff;}
    /* Stat highlights */
    .stat-high-bar {margin-bottom:0.5em;}
    /* Premium NavBar Pill */
    .nav-glass-pill {
      width: 100vw;
      max-width: 99vw;
      position: fixed; bottom: 11px; left: 0; z-index:500;
      display: flex; justify-content: space-evenly; align-items: flex-end;
      background: var(--nav-glass);
      border-radius: 19px; box-shadow: 0 6px 40px #38b6ff17;
      padding: 0.27em 0 0.15em 0; margin: 0 auto;
      backdrop-filter: blur(13px);
      border: 1.5px solid #b2d9fc44;
      margin-left: 50%; transform: translateX(-50%);
    }
    .nav-glass-pill .nav-item {
      flex:1 1 0; position:relative; z-index:2;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      font-size: 0.92em; font-weight: 700;
      color: #bcc9e9; min-width: 0;
      border: none; outline: none; background: none; cursor: pointer;
      transition: color 0.18s, font-size 0.18s;
      padding: 0.07em 0 0.13em 0;
      margin: 0;
    }
    .nav-glass-pill .nav-item.active {
      color: var(--accent2); font-size:1.13em; font-weight: 800;
    }
    .nav-glass-pill .nav-icon {
      font-size: 1.43em;
      margin-bottom: 0.08em;
      background: none;
      transition: transform 0.18s;
    }
    .nav-glass-pill .nav-item.active .nav-icon {
      transform: translateY(-4px) scale(1.17);
      color: var(--accent2);
      text-shadow: 0 2px 8px #ffc93a17;
    }
    .nav-glass-pill .nav-label { font-size:0.81em; }
    .footer-icons {margin-top:1.15rem;text-align:center;display:flex;justify-content:center;align-items:center;gap:1.2rem;}
    .footer-icons img {height:17px;width:17px;vertical-align:middle;border-radius:3px;background:#fff;border:1px solid #bfe4fa;box-shadow:0 1px 4px rgba(0,0,0,0.02);}
    .footer-suca {margin-top:0.6rem;text-align:center;color:#bdbdbd;font-size:0.88rem;}
    @media (max-width:540px) {
      main {padding:0.62rem 0.01rem 3.6rem 0.01rem;}
      header img {height:22px;}
      .card {padding:0.52em 0.09em;}
      .date-heading {font-size: 1em;}
      .squad-grid {grid-template-columns:1fr 1fr;}
      .nav-glass-pill {padding: 0.07em 0 0.07em 0;}
      .nav-glass-pill .nav-label { font-size:0.76em; }
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo"/>
    <div class="titlebox">
      <h1>Royal Darts Premier League 2025</h1>
    </div>
  </header>
  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="card">
        <h3>Today's Fixtures</h3>
        <div class="table-scroll">
          <table class="fixtures-table" id="dashboard-fixtures-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Team 1</th>
                <th></th>
                <th>Team 2</th>
              </tr>
            </thead>
            <tbody id="dashboard-fixtures"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:-0.7em;">
        <h3>Quick Standings</h3>
        <div class="standings-group-title">Group A</div>
        <div class="table-scroll"><table class="standings-table"><thead>
          <tr><th>Pos</th><th>Team</th><th>Pts</th></tr>
        </thead><tbody id="dashboard-standings-a"></tbody></table></div>
        <div class="standings-group-title">Group B</div>
        <div class="table-scroll"><table class="standings-table"><thead>
          <tr><th>Pos</th><th>Team</th><th>Pts</th></tr>
        </thead><tbody id="dashboard-standings-b"></tbody></table></div>
      </div>
      <div class="card" style="margin-top:1.1em;margin-bottom:0.6em;">
        <h3>Stats Highlights</h3>
        <div id="home-stat-highlights"></div>
      </div>
    </section>
    <!-- FIXTURES -->
    <section id="fixtures" class="section"><div class="card"><h3>Fixtures</h3><div id="fixturesTableContainer"></div></div></section>
    <!-- RESULTS -->
    <section id="results" class="section"><div class="card"><h3>Results</h3><div id="resultsContainer"></div></div></section>
    <!-- STANDINGS -->
    <section id="standings" class="section">
      <div class="card" style="margin-bottom:0.8em;">
        <div class="stand-legend">
          <span class="gold"><i class="lucide lucide-trophy" style="font-size:1.09em;vertical-align:middle;margin-right:3px;"></i>Gold Cup</span>
          <span class="silver"><i class="lucide lucide-award" style="font-size:1.05em;vertical-align:middle;margin-right:3px;"></i>Silver Cup</span>
          <span class="elim"><i class="lucide lucide-x-circle" style="font-size:1.03em;vertical-align:middle;margin-right:3px;"></i>Eliminated</span>
        </div>
        <h3>Standings</h3>
        <div class="standings-group-title">Group A</div>
        <div id="standings-a"></div>
        <div class="standings-group-title" style="margin-top:1.2em;">Group B</div>
        <div id="standings-b"></div>
      </div>
    </section>
    <!-- SQUADS -->
    <section id="squads" class="section">
      <div class="card">
        <h3>Squads</h3>
        <div id="squadsContainer" class="squad-grid"></div>
      </div>
    </section>
    <!-- STATS -->
    <section id="stats" class="section">
      <div class="card"><h3>Player Stats</h3>
        <div id="stat-highlights"></div>
        <div class="team-filter-bar" id="team-filter-bar"></div>
        <input id="stats-search" type="text" placeholder="Search player or team..." style="margin-bottom:0.8em;padding:0.33em 0.49em;font-size:0.96em;width:98vw;max-width:210px;border-radius:5px;border:1px solid #e2ecf4;display:block;margin:auto;">
        <div id="stats-table"></div>
      </div>
    </section>
    <!-- LIVE -->
    <section id="live" class="section">
      <div class="card">
        <h3>Watch Live</h3>
        <iframe src="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" width="100%" height="420" frameborder="0" style="border-radius:12px;border:none;"></iframe>
      </div>
    </section>
  </main>
  <!-- Modern Glass Pill Navigation -->
  <div class="nav-glass-pill">
    <button class="nav-item active" onclick="showTab('dashboard')" title="Home"><span class="nav-icon lucide lucide-home"></span><span class="nav-label">Home</span></button>
    <button class="nav-item" onclick="showTab('fixtures')" title="Fixtures"><span class="nav-icon lucide lucide-calendar-days"></span><span class="nav-label">Fixtures</span></button>
    <button class="nav-item" onclick="showTab('results')" title="Results"><span class="nav-icon lucide lucide-list-start"></span><span class="nav-label">Results</span></button>
    <button class="nav-item" onclick="showTab('standings')" title="Standings"><span class="nav-icon lucide lucide-trophy"></span><span class="nav-label">Standings</span></button>
    <button class="nav-item" onclick="showTab('squads')" title="Squads"><span class="nav-icon lucide lucide-users"></span><span class="nav-label">Squads</span></button>
    <button class="nav-item" onclick="showTab('stats')" title="Stats"><span class="nav-icon lucide lucide-bar-chart"></span><span class="nav-label">Stats</span></button>
    <button class="nav-item" onclick="showTab('live')" title="Live"><span class="nav-icon lucide lucide-play-circle"></span><span class="nav-label">Live</span></button>
  </div>
  <!-- Player popup -->
  <div id="player-popup" onclick="hidePlayerPopup(event)">
    <div class="popup-card"></div>
    <button class="popup-close" onclick="hidePlayerPopup(event)">&times;</button>
  </div>
  <footer style="margin-bottom:80px">
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank"><img src="https://n01darts.com/favicon.ico" alt="Nakka" title="Watch Live on Nakka" /></a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" /></a>
    </div>
    <div class="footer-suca">Built by SUCA Analytics</div>
  </footer>
  <script>
    // TEAM LOGOS, API URL
    const TEAM_LOGOS = {
      "Balaji Darts": "team_logos/Balaji-Darts.avif",
      "Biscotti Barrels": "team_logos/Biscotti-Barrels.avif",
      "BLC High Rollers": "team_logos/BLC-High-Rollers.avif",
      "Bullseye Bandits": "team_logos/Bullseye-Bandits.avif",
      "City Knights": "team_logos/City-Knights.avif",
      "Hugo & Finn": "team_logos/Hugo-&-Finn.png",
      "Keventer Eagle Eye": "team_logos/Keventer-Eagle-Eye.avif",
      "PKS Titans": "team_logos/PKS-Titans.avif",
      "Purti Forever": "team_logos/Purti-Forever.avif",
      "Rama Darts": "team_logos/Rama-Darts.png",
      "Royals Super Knights": "team_logos/Royals-Super-Knights.avif",
      "RSV Rising Stars": "team_logos/RSV-Rising-Stars.avif",
      "The Panthers": "team_logos/The-Panthers.avif",
      "Tons of Bull": "team_logos/Tons-of-Bull.avif",
      "UGW": "team_logos/UGW.png",
      "Vyana Warriors": "team_logos/Vyana-Warriors.avif"
    };
    const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';

    // Nav functionality
    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.nav-item').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      let navBtns = Array.from(document.querySelectorAll('.nav-glass-pill .nav-item'));
      navBtns.forEach(btn => {
        if(btn.innerText.toLowerCase().includes(tabId)) btn.classList.add('active');
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }
    // Data cache
    let fixturesCache = [], standingsCache = [], statsCache = [], bestLegCache = [], squadsCache = [], resultsCache = [];
    let statsSortKey = null, statsSortDir = 1, statsSearchTerm = "", teamFilter = null;
    const STATS_HIDE_COLUMNS = new Set([
      "Keep", "Break", "Second Legs", "Break Legs", "Total Score", "Total Darts", "Group", "Best Leg", "Worst Leg"
    ]);

    // API Fetch & Render all
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        standingsCache = data.Standings || [];
        statsCache = (data.Stats || []).filter(row => row.Player);
        bestLegCache = (data["Best Leg"] || []).filter(row => row["Best Leg"]);
        squadsCache = data.Squads || [];
        resultsCache = data.Results || [];
        renderDashboardFixtures();
        renderDashboardStandingsTables();
        renderFixtures(fixturesCache);
        renderResults(resultsCache, fixturesCache);
        renderStandingsTables();
        renderSquads(squadsCache);
        renderStatHighlights(statsCache, bestLegCache, "home-stat-highlights");
        renderStatHighlights(statsCache, bestLegCache, "stat-highlights");
        renderStats(statsCache, bestLegCache);
        renderTeamFilter(statsCache);
      } catch (err) {console.error('Failed to load data:', err);}
    }
    // --- DASHBOARD: Today's Fixtures ---
    function renderDashboardFixtures() {
      const [istStart, istEnd] = getISTTodayRange();
      const todaysFixtures = fixturesCache.filter(fix => {
        const d = new Date(fix.Date);
        return d >= istStart && d <= istEnd;
      });
      let html = '';
      if (!todaysFixtures.length) {
        html = `<tr><td colspan="4" style="color:var(--primary);">No fixtures today.</td></tr>`;
      } else {
        todaysFixtures.forEach(f => {
          html += `<tr>
            <td>${new Date(f.Time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'})}</td>
            <td class="curl">${curlText(f['Team 1']) || ""}</td>
            <td></td>
            <td class="curl">${curlText(f['Team 2']) || ""}</td>
          </tr>`;
        });
      }
      document.getElementById('dashboard-fixtures').innerHTML = html;
    }
    // --- DASHBOARD: Standings (2 Tables, all teams, curl names, no elim/medals, centered) ---
    function renderDashboardStandingsTables() {
      const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
      const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
      document.getElementById('dashboard-standings-a').innerHTML = quickStandingsRows(A);
      document.getElementById('dashboard-standings-b').innerHTML = quickStandingsRows(B);
    }
    function quickStandingsRows(arr) {
      return arr.map((s,i) => {
        let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
        return `<tr class="stand-row ${groupClass}">
          <td>${i+1}</td>
          <td class="curl" style="text-align:center;"><img class="stand-teamlogo" src="${TEAM_LOGOS[s.Team]||''}" alt="">${curlText(s.Team)}</td>
          <td class="stand-points" style="text-align:center;">${s.Points}</td>
        </tr>`;
      }).join('');
    }
    // --- FIXTURES ---
    function renderFixtures(fixtures) {
      const container = document.getElementById('fixturesTableContainer');
      if (!fixtures.length) {
        container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
        return;
      }
      const byDate = {};
      fixtures.forEach(f => {
        const d = new Date(f.Date).toDateString();
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(f);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll">
        <table class="fixtures-table">
          <thead>
            <tr><th>Time</th><th>Team 1</th><th></th><th>Team 2</th></tr>
          </thead>
          <tbody>`;
        byDate[dateStr].forEach(f => {
          html += `<tr>
              <td>${new Date(f.Time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td class="curl">${curlText(f['Team 1'] || "")}</td>
              <td></td>
              <td class="curl">${curlText(f['Team 2'] || "")}</td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      container.innerHTML = html;
    }
    // --- RESULTS (winner highlighted) ---
    function renderResults(results, fixtures) {
      const fixtureDateMap = {};
      fixtures.forEach(fix => {
        const t1 = fix["Team 1"], t2 = fix["Team 2"];
        const dateStr = new Date(fix.Date).toDateString();
        fixtureDateMap[`${t1}|${t2}`] = dateStr;
        fixtureDateMap[`${t2}|${t1}`] = dateStr;
      });
      const byDate = {};
      results.forEach(r => {
        let dateVal = "";
        if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
          dateVal = new Date(r.Date).toDateString();
        } else {
          const t1 = r["Team 1"], t2 = r["Team 2"];
          dateVal = fixtureDateMap[`${t1}|${t2}`] || fixtureDateMap[`${t2}|${t1}`] || "Unknown Date";
        }
        if (!byDate[dateVal]) byDate[dateVal] = [];
        byDate[dateVal].push(r);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll">
          <table class="results-table">
            <thead>
              <tr>
                <th>Avg 1</th>
                <th>Team 1</th>
                <th>Score</th>
                <th class="divider-cell"></th>
                <th>Score</th>
                <th>Team 2</th>
                <th>Avg 2</th>
              </tr>
            </thead>
            <tbody>`;
        byDate[dateStr].forEach(r => {
          const win1 = +r['Legs 1'] > +r['Legs 2'];
          const win2 = +r['Legs 2'] > +r['Legs 1'];
          html += `<tr class="result-row">
            <td>${r['Avg 1']||""}</td>
            <td class="curl${win1?" result-winner":""}" style="text-align:center;">${curlText(r['Team 1']||"")}</td>
            <td style="text-align:center;"${win1?' class="result-winner"':''}>${r['Legs 1']===0?"0":r['Legs 1']||"0"}</td>
            <td class="divider-cell"><div class="divider-line"></div></td>
            <td style="text-align:center;"${win2?' class="result-winner"':''}>${r['Legs 2']===0?"0":r['Legs 2']||"0"}</td>
            <td class="curl${win2?" result-winner":""}" style="text-align:center;">${curlText(r['Team 2']||"")}</td>
            <td>${r['Avg 2']||""}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      document.getElementById('resultsContainer').innerHTML = html || '';
    }
    // --- Standings Page ---
    function renderStandingsTables() {
      const A = standingsCache.filter(s => s.Group?.toUpperCase() === 'A').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
      const B = standingsCache.filter(s => s.Group?.toUpperCase() === 'B').sort((a,b)=>b.Points-a.Points || b.LD-a.LD);
      document.getElementById('standings-a').innerHTML = standingsTable(A);
      document.getElementById('standings-b').innerHTML = standingsTable(B);
    }
    function standingsTable(arr) {
      let html = `<div class="table-scroll"><table class="standings-table"><thead>
        <tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th><th>Avg</th></tr>
      </thead><tbody>`;
      arr.forEach((s,i) => {
        let groupClass = i < 3 ? "gold" : i < 6 ? "silver" : "elim";
        html += `<tr class="stand-row ${groupClass}">
          <td>${i+1}</td>
          <td class="curl" style="text-align:center;"><img class="stand-teamlogo" src="${TEAM_LOGOS[s.Team]||''}" alt="">${curlText(s.Team)}</td>
          <td style="text-align:center;">${s.P}</td>
          <td style="text-align:center;">${s.W}</td>
          <td style="text-align:center;">${s.L}</td>
          <td class="stand-points" style="text-align:center;">${s.Points}</td>
          <td style="text-align:center;">${s.Avg}</td>
        </tr>`;
      });
      html += "</tbody></table></div>";
      return html;
    }
    // --- SQUADS (premium card grid) ---
    function renderSquads(squads) {
      const container = document.getElementById('squadsContainer');
      if (!squads.length) { container.innerHTML = 'Loading...'; return; }
      const teams = [...new Set(squads.map(s => s.Team))];
      let html = '';
      teams.forEach(team => {
        const logo = TEAM_LOGOS[team] || "";
        const players = squads.filter(s => s.Team === team).map(p =>
          `<div class="squad-player-name curl" tabindex="0">${curlText(p.Player)}</div>`
        ).join('');
        html += `<div class="squad-team-card">
          <div class="squad-logo-frame"><img src="${logo}" alt="${team}"></div>
          <div class="squad-team-name curl">${curlText(team)}</div>
          <div class="squad-players">${players}</div>
        </div>`;
      });
      container.innerHTML = html;
    }
    // --- STATS ---
    function renderStatHighlights(stats, bestLegsSheet, id="stat-highlights") {
      const defs = [
        {key:"3 Dart Avg", label:"Best 3-Dart Avg"},
        {key:"First 9 Avg", label:"Best First 9 Avg"},
        {key:"Legs Won", label:"Most Legs Won"},
        {key:"High Finish", label:"Highest Finish"}
      ];
      const eligible = stats.filter(p => Number(p["Match Played"]) >= 2);
      let html = `<div class="stat-high-bar" style="display:flex;gap:0.27em;flex-wrap:wrap;justify-content:center;">`;
      defs.forEach(def => {
        const sorted = [...eligible].sort((a,b) => +b[def.key] - +a[def.key]);
        const player = sorted[0];
        if (!player) return;
        const team = player.Team || "";
        const logo = TEAM_LOGOS[team] || "";
        let val = player[def.key] ?? "—";
        html += `<div class="stat-high-card" style="background:var(--background);border-radius:10px;padding:0.43em 0.19em;min-width:88px;max-width:110px;text-align:center;box-shadow:0 1px 4px #b1e1ff18;">
          <div class="stat-high-label" style="color:var(--accent);font-weight:700;">${def.label}</div>
          <div class="stat-high-main" style="font-size:1.12em;font-weight:700;color:var(--primary);">${val}</div>
          <div class="stat-high-player" style="font-size:0.91em;">
            ${logo?`<img src="${logo}" style="width:10px;height:10px;vertical-align:middle;margin-bottom:2px;"> `:""}
            ${player.Player} <br> <span style="color:#496d8a;font-weight:600;">${player.Team}</span>
          </div>
        </div>`;
      });
      // Best Leg (from sheet)
      if (bestLegsSheet && bestLegsSheet.length) {
        let best = bestLegsSheet.sort((a,b)=>Number(a["Best Leg"])-Number(b["Best Leg"]))[0];
        const logo = TEAM_LOGOS[best.Team] || "";
        html += `<div class="stat-high-card" style="background:var(--background);border-radius:10px;padding:0.43em 0.19em;min-width:88px;max-width:110px;text-align:center;box-shadow:0 1px 4px #b1e1ff18;">
          <div class="stat-high-label" style="color:var(--accent);font-weight:700;">Best Leg</div>
          <div class="stat-high-main" style="font-size:1.12em;font-weight:700;color:var(--primary);">${best["Best Leg"]}</div>
          <div class="stat-high-player" style="font-size:0.91em;">
            ${logo?`<img src="${logo}" style="width:10px;height:10px;vertical-align:middle;margin-bottom:2px;"> `:""}
            ${best.Players} <br> <span style="color:#496d8a;font-weight:600;">${best.Team}</span>
          </div>
        </div>`;
      }
      html += "</div>";
      document.getElementById(id).innerHTML = html;
    }
    function renderTeamFilter(stats) {
      const bar = document.getElementById('team-filter-bar');
      if (!stats || !stats.length) { bar.innerHTML = ''; return;}
      const allTeams = Array.from(new Set(stats.map(p => p.Team).filter(Boolean))).sort();
      let html = `<select class="team-filter-dropdown" onchange="setTeamFilter(this.value)">
        <option value="">All Teams</option>`;
      allTeams.forEach(team => {
        html += `<option value="${team.replace(/"/g, "&quot;")}"${teamFilter===team?" selected":""}>${team}</option>`;
      });
      html += `</select>`;
      bar.innerHTML = html;
    }
    window.setTeamFilter = function(team) {
      teamFilter = team || null;
      renderStats(statsCache, bestLegCache);
    };
    function renderStats(stats, bestLegsSheet) {
      const searchInput = document.getElementById('stats-search');
      if (searchInput && !searchInput._listenerAdded) {
        searchInput.addEventListener("input", () => {
          statsSearchTerm = searchInput.value.trim().toLowerCase();
          renderStats(statsCache, bestLegCache);
        });
        searchInput._listenerAdded = true;
      }
      let filteredStats = stats;
      if (teamFilter) filteredStats = filteredStats.filter(p => p.Team === teamFilter);
      if (statsSearchTerm) {
        filteredStats = filteredStats.filter(
          p => (p.Player && p.Player.toLowerCase().includes(statsSearchTerm)) ||
               (p.Team && p.Team.toLowerCase().includes(statsSearchTerm))
        );
      }
      if (statsSortKey) {
        filteredStats = [...filteredStats].sort((a, b) => {
          let v1 = a[statsSortKey], v2 = b[statsSortKey];
          let n1 = parseFloat(v1), n2 = parseFloat(v2);
          if (!isNaN(n1) && !isNaN(n2)) {
            return statsSortDir * (n1 - n2);
          } else {
            return statsSortDir * (String(v1).localeCompare(String(v2)));
          }
        });
      }
      if (filteredStats.length) {
        const wantedHeaders = Object.keys(filteredStats[0]).filter(
          h => h && h !== "" && h !== undefined && h !== null && !STATS_HIDE_COLUMNS.has(h)
        );
        let table = "<div class='table-scroll'><table><thead><tr>";
        wantedHeaders.forEach(h => {
          let dirArrow = "";
          if (statsSortKey === h) dirArrow = statsSortDir > 0 ? " ▲" : " ▼";
          table += `<th onclick="setStatsSort('${h}')">${h}${dirArrow}</th>`;
        });
        table += "</tr></thead><tbody>";
        filteredStats.forEach(row => {
          table += "<tr>" + wantedHeaders.map(h => {
            let val = row[h] ?? "";
            if (h === "Win Rate (Sets)" || h === "Win Rate (Legs)") {
              val = isNaN(parseFloat(val)) ? "" : `${Math.round(parseFloat(val) * 100)}%`;
            }
            if (h === "Player") {
              return `<td class="stat-player curl" title="${val}" onclick="showPlayerPopup('${row.Player.replace(/'/g,"\\'")}')">${curlText(val)}</td>`;
            }
            if (h === "Team" && TEAM_LOGOS[val]) {
              return `<td class="stat-team curl" title="${val}"><img src="${TEAM_LOGOS[val]}" alt="${val}" style="width:10px;height:10px;vertical-align:middle;margin-right:2px;">${curlText(val)}</td>`;
            }
            return `<td>${val}</td>`;
          }).join("") + "</tr>";
        });
        table += "</tbody></table></div>";
        document.getElementById("stats-table").innerHTML = table;
      } else {
        document.getElementById("stats-table").innerHTML = "<p>No player stats available.</p>";
      }
    }
    window.setStatsSort = function(h) {
      if (statsSortKey === h) {
        statsSortDir = -statsSortDir;
      } else {
        statsSortKey = h;
        statsSortDir = 1;
      }
      renderStats(statsCache, bestLegCache);
    };
    // Player pop-up functionality
    function showPlayerPopup(playerName) {
      let p = statsCache.find(s => s.Player === playerName);
      if (!p) return;
      let logo = p.Team && TEAM_LOGOS[p.Team] ? `<img src="${TEAM_LOGOS[p.Team]}" style="width:18px;height:18px;border-radius:5px;vertical-align:middle;margin-bottom:0.13em;"><br>` : "";
      let card = `<div class="popup-card">
        <div class="popup-head">${logo}${curlText(p.Player)}</div>
        <div class="popup-team">${curlText(p.Team||"")}</div>
        <div style="color:var(--primary);font-size:1em;font-weight:700;">Stats</div>
        ${Object.keys(p).map(h => {
          if (["Player", "Team"].includes(h) || STATS_HIDE_COLUMNS.has(h) || !p[h]) return "";
          return `<div class="popup-label"><span style="color:var(--accent);font-weight:600;">${h}:</span> ${p[h]}</div>`;
        }).join("")}
      </div>`;
      document.querySelector("#player-popup .popup-card").innerHTML = card;
      document.getElementById("player-popup").style.display = "flex";
    }
    function hidePlayerPopup(e) {
      if (!e || !e.target || e.target.id === "player-popup" || e.target.classList.contains("popup-close"))
        document.getElementById("player-popup").style.display = "none";
    }
    // IST Today util
    function getISTTodayRange() {
      const now = new Date();
      const IST_OFFSET = 330;
      const local = new Date(now.getTime() + ((IST_OFFSET - now.getTimezoneOffset())*60*1000));
      const istYear = local.getFullYear(), istMonth = local.getMonth(), istDay = local.getDate();
      const istStart = new Date(Date.UTC(istYear, istMonth, istDay, 0, -IST_OFFSET, 0));
      const istEnd = new Date(Date.UTC(istYear, istMonth, istDay, 23, 59-IST_OFFSET, 59));
      return [istStart, istEnd, ""];
    }
    // Utility: Curl name to two lines (without breaking inside words if possible)
    function curlText(txt) {
      if (!txt) return '';
      let parts = txt.split(" ");
      if (parts.length <= 1) return txt;
      let mid = Math.ceil(parts.length/2);
      return parts.slice(0,mid).join(" ")+"\n"+parts.slice(mid).join(" ");
    }
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
