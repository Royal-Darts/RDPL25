<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Royal Darts Premier League 2025</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/174/174855.png" />
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f8f8;
    }
    header {
      background-color: #121212;
      color: white;
      padding: 1rem;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header img {
      max-height: 60px;
      margin-bottom: 8px;
    }
    nav {
      background-color: #1f1f1f;
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
    }
    nav button {
      flex: 1;
      padding: 1rem;
      color: white;
      background: none;
      border: none;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.16s;
    }
    nav button:hover,
    nav button.active {
      background-color: #333;
    }
    main { padding: 1rem; }
    .section { display: none; }
    .section.active { display: block; }
    .table-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
      margin-bottom: 2rem;
    }
    table {
      width: 100%;
      min-width: 600px;
      border-collapse: collapse;
      margin-bottom: 1.5rem;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    th, td {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: center;
      vertical-align: middle;
    }
    th {
      background: #ececec;
      cursor: pointer;
      user-select: none;
    }
    /* --- MOBILE & WRAPPING --- */
    .team-cell {
      white-space: normal !important;
      word-break: keep-all !important;
      min-width: 75px;
      max-width: 120px;
      font-size: 1rem;
      padding-left: 2px;
      padding-right: 2px;
    }
    @media (max-width: 800px) {
      table { min-width: 0; font-size: 0.93rem;}
      th, td { padding: 0.45rem; font-size: 0.93rem; }
      .team-cell { min-width: 60px; max-width: 80px; font-size: 0.98rem;}
    }
    @media (max-width: 600px) {
      header img { max-height: 50px; }
      nav button { font-size: 0.9rem; padding: 0.75rem; }
      th, td { font-size: 0.85rem; padding: 0.32rem; }
      .team-cell { min-width: 48px; max-width: 65px; font-size: 0.90rem;}
    }
    .date-heading {
      background: #181f2b;
      color: #fff;
      font-size: 1.08rem;
      font-weight: bold;
      letter-spacing: 1px;
      padding: 0.6rem 1rem;
      border-radius: 6px;
      margin: 30px 0 8px 0;
      display: inline-block;
    }
    .standings-key {
      font-size: 0.8rem;
      margin-top: 0.5rem;
      color: #444;
    }
    .group-title {
      font-size: 1.07rem;
      font-weight: 600;
      margin: 18px 0 8px 0;
      color: #21405a;
      letter-spacing: 1px;
      text-align: left;
    }
    .team-card {
      flex: 1 1 calc(25% - 1rem);
      min-width: 220px;
      background: #fff;
      padding: 1.1rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      margin-bottom: 1.5rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      position: relative;
    }
    .team-card-header {
      display: flex;
      align-items: center;
      margin-bottom: 0.7rem;
      gap: 0.7rem;
    }
    .team-card-header img {
      width: 38px;
      height: 38px;
      object-fit: contain;
      border-radius: 8px;
      border: 2px solid #e7e7e7;
      background: #fafbfc;
      box-shadow: 0 0 3px rgba(0,0,0,0.04);
    }
    .team-card h3 {
      font-size: 1.07rem;
      margin: 0;
      font-weight: 600;
      color: #222b4a;
      letter-spacing: 0.5px;
    }
    .team-card ul {
      margin: 0.5rem 0 0 0.2rem;
      padding: 0 0 0 18px;
      font-size: 0.99rem;
    }
    /* --- HIGHLIGHTS --- */
    .highlights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
      gap: 1.7rem;
      margin-bottom: 2rem;
    }
    .highlight-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.10);
      padding: 1.25rem;
      text-align: center;
      font-size: 1.12rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 120px;
    }
    .highlight-card strong {
      display: block;
      font-size: 1.12rem;
      margin-bottom: 0.6rem;
      color: #2d3197;
      letter-spacing: 0.04em;
    }
    .highlight-value {
      font-size: 2.0rem;
      font-weight: 700;
      color: #0d891c;
      margin: 0.14em 0 0.08em 0;
      letter-spacing: 1px;
    }
    .highlight-player {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.6em;
      font-size: 1.1rem;
      font-weight: 500;
      color: #343a40;
      margin-bottom: 0.1em;
    }
    .highlight-logo {
      width: 32px; height: 32px; border-radius: 8px; object-fit: contain; border: 1.5px solid #e2e2e2; background:#fff;
    }
    /* --- FOOTER --- */
    .footer-icons {
      margin-top: 0.7rem;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 1.2rem;
    }
    .footer-icons a {
      margin: 0 0.5rem;
      display: inline-block;
      vertical-align: middle;
    }
    .footer-icons img {
      height: 26px;
      width: 26px;
      vertical-align: middle;
      border-radius: 5px;
      background: #fff;
      border: 1px solid #eee;
      box-shadow: 0 1px 4px rgba(0,0,0,0.05);
    }
    .footer-suca {
      margin-top: 0.7rem;
      text-align: center;
      color: #bdbdbd;
      font-size: 0.93rem;
      letter-spacing: 0.01em;
    }
    @media (max-width: 600px) {
      .footer-icons img { height: 22px; width: 22px;}
      .footer-suca { font-size: 0.80rem; }
      .highlight-card {min-height: 98px;}
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Tournament Logo" />
    <h1>Royal Darts Premier League 2025</h1>
  </header>
  <nav>
    <button class="tab-button active" onclick="showTab('fixtures')">Fixtures</button>
    <button class="tab-button" onclick="showTab('results')">Results</button>
    <button class="tab-button" onclick="showTab('standings')">Standings</button>
    <button class="tab-button" onclick="showTab('squads')">Squads</button>
    <button class="tab-button" onclick="showTab('stats')">Stats</button>
  </nav>
  <main>
    <!-- Fixtures -->
    <section id="fixtures" class="section active">
      <div id="fixturesTableContainer"></div>
    </section>
    <!-- Results -->
    <section id="results" class="section">
      <div id="resultsContainer"></div>
    </section>
    <!-- Standings -->
    <section id="standings" class="section">
      <div id="standingsGroupA"></div>
      <div id="standingsGroupB"></div>
      <div class="standings-key">
        <p><strong>EF</strong> = Events For, <strong>EA</strong> = Events Against, <strong>ED</strong> = Event Difference</p>
      </div>
    </section>
    <!-- Squads -->
    <section id="squads" class="section">
      <div id="squadsContainer">Loading...</div>
    </section>
    <!-- Stats -->
    <section id="stats" class="section">
      <input id="stats-search" type="text" placeholder="Search player or team..." style="margin-bottom:1rem;padding:0.4rem 0.6rem;font-size:1rem;width:240px;border-radius:6px;border:1px solid #ccc;">
      <div id="highlights"></div>
      <div id="stats-table"></div>
    </section>
  </main>
  <footer>
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank" class="icon-link">
        <img src="https://n01darts.com/favicon.ico" alt="Nakka" title="Watch Live on Nakka" />
      </a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank" class="icon-link">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" />
      </a>
    </div>
    <div class="footer-suca">Built by SUCA Analytics</div>
  </footer>
  <script>
    // --- LOGO MAPPING ---
    const TEAM_LOGOS = {
      "Balaji Darts": "team_logos/Balaji-Darts.avif",
      "Biscotti Barrels": "team_logos/Biscotti-Barrels.avif",
      "BLC High Rollers": "team_logos/BLC-High-Rollers.avif",
      "Bullseye Bandits": "team_logos/Bullseye-Bandits.avif",
      "City Knights": "team_logos/City-Knights.avif",
      "Hugo & Finn": "team_logos/Hugo-&-Finn.png",
      "Keventer Eagle Eye": "team_logos/Keventer-Eagle-Eye.avif",
      "PKS Titans": "team_logos/PKS-Titans.avif",
      "Purti Forever": "team_logos/Purti-Forever.avif",
      "Rama Darts": "team_logos/Rama-Darts.png",
      "Royals Super Knights": "team_logos/Royals-Super-Knights.avif",
      "RSV Rising Stars": "team_logos/RSV-Rising-Stars.avif",
      "The Panthers": "team_logos/The-Panthers.avif",
      "Tons of Bull": "team_logos/Tons-of-Bull.avif",
      "UGW": "team_logos/UGW.png",
      "Vyana Warriors": "team_logos/Vyana-Warriors.avif"
    };

    const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';

    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
    }

    let fixturesCache = [];
    let statsCache = [];
    let bestLegCache = [];
    let statsSortKey = null;
    let statsSortDir = 1;
    let statsSearchTerm = "";

    // --- columns to hide in stats ---
    const STATS_HIDE_COLUMNS = new Set([
      "Keep", "Break", "Second Legs", "Break Legs", "Total Score", "Total Darts", "Group"
    ]);

    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        renderFixtures(data.Fixtures);
        renderResults(data.Results, fixturesCache);
        renderStandings(data.Standings);
        renderSquads(data.Squads);
        statsCache = (data.Stats || []).filter(row => row.Player);
        bestLegCache = (data["Best Leg"] || []).filter(row => row["Best Leg"]);
        renderStats(statsCache, bestLegCache);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // --- FIXTURES ---
    function renderFixtures(fixtures) {
      const container = document.getElementById('fixturesTableContainer');
      if (!fixtures.length) {
        container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
        return;
      }
      const byDate = {};
      fixtures.forEach(f => {
        const d = new Date(f.Date).toDateString();
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(f);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>
        <div class="table-scroll">
        <table>
          <thead>
            <tr><th>Time</th><th class="team-cell">Team 1</th><th></th><th class="team-cell">Team 2</th></tr>
          </thead>
          <tbody>`;
        byDate[dateStr].forEach(f => {
          html += `<tr>
              <td>${new Date(f.Time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td class="team-cell">${f['Team 1']}</td>
              <td>vs</td>
              <td class="team-cell">${f['Team 2']}</td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      container.innerHTML = html;
    }

    // --- RESULTS: Grouped by Date, then Group ---
    function renderResults(results, fixtures) {
      const fixtureDateMap = {};
      fixtures.forEach(fix => {
        const t1 = fix["Team 1"], t2 = fix["Team 2"];
        const dateStr = new Date(fix.Date).toDateString();
        fixtureDateMap[`${t1}|${t2}`] = dateStr;
        fixtureDateMap[`${t2}|${t1}`] = dateStr;
      });

      const byDate = {};
      results.forEach(r => {
        let dateVal = "";
        if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
          dateVal = new Date(r.Date).toDateString();
        } else {
          const t1 = r["Team 1"], t2 = r["Team 2"];
          dateVal = fixtureDateMap[`${t1}|${t2}`] || fixtureDateMap[`${t2}|${t1}`] || "Unknown Date";
        }
        if (!byDate[dateVal]) byDate[dateVal] = [];
        byDate[dateVal].push(r);
      });

      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading">${dateStr}</div>`;
        const groupA = byDate[dateStr].filter(r => r.Group?.toUpperCase() === 'A');
        if (groupA.length) html += resultsTable(groupA, 'A');
        const groupB = byDate[dateStr].filter(r => r.Group?.toUpperCase() === 'B');
        if (groupB.length) html += resultsTable(groupB, 'B');
      });

      document.getElementById('resultsContainer').innerHTML = html || '';
    }

    function resultsTable(arr, group) {
      return `
        <div class="group-title">Group ${group}</div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th>Avg 1</th>
                <th class="team-cell">Team 1</th>
                <th>Score</th>
                <th>vs</th>
                <th>Score</th>
                <th class="team-cell">Team 2</th>
                <th>Avg 2</th>
              </tr>
            </thead>
            <tbody>
              ${arr.map(r => `<tr>
                <td>${r['Avg 1']}</td>
                <td class="team-cell">${r['Team 1']}</td>
                <td>${r['Legs 1']}</td>
                <td>vs</td>
                <td>${r['Legs 2']}</td>
                <td class="team-cell">${r['Team 2']}</td>
                <td>${r['Avg 2']}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
    }

    // --- STANDINGS (with Team Logos) ---
    function renderStandings(standings) {
      const A = standings.filter(s => s.Group?.toUpperCase() === 'A');
      const B = standings.filter(s => s.Group?.toUpperCase() === 'B');
      const sortArr = arr => arr.sort((a, b) => b.Points - a.Points || b.LD - a.LD);
      const tableHTML = (arr, group) => `
        <div class="group-title">Group ${group}</div>
        <div class="table-scroll">
          <table>
            <thead>
              <tr>
                <th class="team-cell">Team</th>
                <th>P</th>
                <th>W</th>
                <th>L</th>
                <th>EF</th>
                <th>EA</th>
                <th>ED</th>
                <th>Pts</th>
                <th>Avg</th>
              </tr>
            </thead>
            <tbody>
              ${sortArr(arr).map(s => `<tr>
                <td class="team-cell">
                  <img src="${TEAM_LOGOS[s.Team] || "https://via.placeholder.com/32x32?text=Logo"}" alt="" style="width:24px;height:24px;border-radius:5px;margin-right:6px;vertical-align:middle;border:1.2px solid #ececec;box-shadow:0 1px 3px #0001;background:#fff;"> 
                  ${s.Team}
                </td>
                <td>${s.P}</td>
                <td>${s.W}</td>
                <td>${s.L}</td>
                <td>${s.LF}</td>
                <td>${s.LA}</td>
                <td>${s.LD}</td>
                <td>${s.Points}</td>
                <td>${s.Avg}</td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>`;
      document.getElementById('standingsGroupA').innerHTML = tableHTML(A, 'A');
      document.getElementById('standingsGroupB').innerHTML = tableHTML(B, 'B');
    }

    // --- SQUADS ---
    function renderSquads(squads) {
      const container = document.getElementById('squadsContainer');
      if (!squads.length) {
        container.innerHTML = 'Loading...';
        return;
      }
      const teams = [...new Set(squads.map(s => s.Team))];
      let html = '<div style="display:flex;flex-wrap:wrap;gap:1.5rem;">';
      teams.forEach(team => {
        const logo = TEAM_LOGOS[team] || "https://via.placeholder.com/38x38?text=Logo";
        const players = squads.filter(s => s.Team === team).map(p => `<li>${p.Player}</li>`).join('');
        html += `
          <div class="team-card">
            <div class="team-card-header">
              <img src="${logo}" alt="${team} logo" onerror="this.src='https://via.placeholder.com/38x38?text=Logo'" />
              <h3>${team}</h3>
            </div>
            <ul>${players}</ul>
          </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    // --- STATS + HIGHLIGHTS + SORT + SEARCH ---
    function renderStats(stats, bestLegsSheet) {
      // SEARCH
      const searchInput = document.getElementById('stats-search');
      if (searchInput && !searchInput._listenerAdded) {
        searchInput.addEventListener("input", () => {
          statsSearchTerm = searchInput.value.trim().toLowerCase();
          renderStats(statsCache, bestLegCache);
        });
        searchInput._listenerAdded = true;
      }

      // --- filter and sort
      let filteredStats = stats;
      if (statsSearchTerm) {
        filteredStats = stats.filter(
          p => (p.Player && p.Player.toLowerCase().includes(statsSearchTerm)) ||
               (p.Team && p.Team.toLowerCase().includes(statsSearchTerm))
        );
      }
      if (statsSortKey) {
        filteredStats = [...filteredStats].sort((a, b) => {
          let v1 = a[statsSortKey], v2 = b[statsSortKey];
          let n1 = parseFloat(v1), n2 = parseFloat(v2);
          if (!isNaN(n1) && !isNaN(n2)) {
            return statsSortDir * (n1 - n2);
          } else {
            return statsSortDir * (String(v1).localeCompare(String(v2)));
          }
        });
      }

      // --- Highlights (min 2 matches)
      const highlightsDefs = [
        { key: "3 Dart Avg", label: "Best 3-Dart Avg", compare: (a,b) => +b["3 Dart Avg"] - +a["3 Dart Avg"] },
        { key: "First 9 Avg", label: "Best First 9 Avg", compare: (a,b) => +b["First 9 Avg"] - +a["First 9 Avg"] },
        { key: "Legs Won", label: "Most Legs Won", compare: (a,b) => +b["Legs Won"] - +a["Legs Won"] },
        { key: "High Finish", label: "Highest Finish", compare: (a,b) => +b["High Finish"] - +a["High Finish"] }
      ];
      const eligible = stats.filter(p => Number(p["Match Played"]) >= 2);

      let html = "<h2>Highlights</h2><div class='highlights-grid'>";
      highlightsDefs.forEach(def => {
        const sorted = [...eligible].sort(def.compare);
        const best = sorted[0];
        const team = best?.Team || "";
        const logo = TEAM_LOGOS[team] || "";
        let val = best?.[def.key] ?? "—";
        if (def.key === "Win Rate (Sets)" || def.key === "Win Rate (Legs)") {
          val = isNaN(parseFloat(val)) ? "—" : `${Math.round(parseFloat(val) * 100)}%`;
        }
        html += `<div class='highlight-card'>
          <div class='highlight-player'>${logo ? `<img src="${logo}" class="highlight-logo" alt="${team}">` : ""}${best?.Player || "—"}</div>
          <strong>${def.label}</strong>
          <span class="highlight-value">${val}</span>
        </div>`;
      });

      // --- BEST LEG (from Best Leg sheet)
      let bestLegHtml = "—";
      if (bestLegsSheet && bestLegsSheet.length) {
        let minBest = Math.min(...bestLegsSheet.map(row => Number(row["Best Leg"])).filter(n => !isNaN(n)));
        let bestRows = bestLegsSheet.filter(row => Number(row["Best Leg"]) === minBest);
        bestLegHtml = bestRows.length
          ? bestRows.map(row =>
            `<div class='highlight-player'>
              ${TEAM_LOGOS[row.Team] ? `<img src="${TEAM_LOGOS[row.Team]}" class="highlight-logo" alt="${row.Team}">` : ""}
              ${row.Players} (${row.Team})
            </div>
            <span class="highlight-value">${row["Best Leg"]}</span>`
          ).join("")
          : "—";
      }
      html += `<div class='highlight-card'><strong>Best Leg</strong>${bestLegHtml}</div>`;
      html += "</div>";
      document.getElementById("highlights").innerHTML = html;

      // --- Stats Table ---
      if (filteredStats.length) {
        // --- Format Win Rate columns as % and remove unwanted columns
        const wantedHeaders = Object.keys(filteredStats[0]).filter(
          h => h && h !== "" && h !== undefined && h !== null && !STATS_HIDE_COLUMNS.has(h)
        );
        let table = "<div class='table-scroll'><table><thead><tr>";
        wantedHeaders.forEach(h => {
          let dirArrow = "";
          if (statsSortKey === h) dirArrow = statsSortDir > 0 ? " ▲" : " ▼";
          table += `<th onclick="setStatsSort('${h}')">${h}${dirArrow}</th>`;
        });
        table += "</tr></thead><tbody>";
        filteredStats.forEach(row => {
          table += "<tr>" + wantedHeaders.map(h => {
            let val = row[h] ?? "";
            if (h === "Win Rate (Sets)" || h === "Win Rate (Legs)") {
              val = isNaN(parseFloat(val)) ? "" : `${Math.round(parseFloat(val) * 100)}%`;
            }
            return `<td>${val}</td>`;
          }).join("") + "</tr>";
        });
        table += "</tbody></table></div>";
        document.getElementById("stats-table").innerHTML = table;
      } else {
        document.getElementById("stats-table").innerHTML = "<p>No player stats available.</p>";
      }
    }

    // GLOBAL SORT HOOK for table headers
    window.setStatsSort = function(h) {
      if (statsSortKey === h) {
        statsSortDir = -statsSortDir;
      } else {
        statsSortKey = h;
        statsSortDir = 1;
      }
      renderStats(statsCache, bestLegCache);
    };

    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
