<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Royal Darts Premier League 2025</title>
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/174/174855.png" />
  <style>
    /* ... keep all your existing CSS ... */
    .highlights-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .highlight-card {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 1.25rem;
      text-align: center;
      font-size: 1.12rem;
    }
    .highlight-card strong {
      display: block;
      font-size: 1.08rem;
      margin-bottom: 0.5rem;
      color: #4040a1;
    }
    .stats-search-bar {
      width: 100%;
      max-width: 360px;
      margin-bottom: 1.1rem;
      font-size: 1.08rem;
      padding: 0.6rem 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      outline: none;
    }
    .sortable {
      cursor: pointer;
    }
    .sorted-asc::after {
      content: " ▲";
      font-size: 0.95em;
    }
    .sorted-desc::after {
      content: " ▼";
      font-size: 0.95em;
    }
  </style>
</head>
<body>
  <!-- ... header/nav/etc unchanged ... -->
  <header>
    <img src="logo.png" alt="Tournament Logo" />
    <h1>Royal Darts Premier League 2025</h1>
  </header>
  <nav>
    <button class="tab-button active" onclick="showTab('fixtures')">Fixtures</button>
    <button class="tab-button" onclick="showTab('results')">Results</button>
    <button class="tab-button" onclick="showTab('standings')">Standings</button>
    <button class="tab-button" onclick="showTab('squads')">Squads</button>
    <button class="tab-button" onclick="showTab('stats')">Stats</button>
  </nav>
  <main>
    <!-- ... fixtures/results/standings/squads unchanged ... -->
    <section id="fixtures" class="section active"><div id="fixturesTableContainer"></div></section>
    <section id="results" class="section"><div id="resultsContainer"></div></section>
    <section id="standings" class="section"><div id="standingsGroupA"></div><div id="standingsGroupB"></div><div class="standings-key"><p><strong>EF</strong> = Events For, <strong>EA</strong> = Events Against, <strong>ED</strong> = Event Difference</p></div></section>
    <section id="squads" class="section"><div id="squadsContainer">Loading...</div></section>
    <section id="stats" class="section">
      <div id="highlights"></div>
      <input type="text" id="statsSearch" class="stats-search-bar" placeholder="Search Player or Team..." oninput="filterStats()" />
      <div id="stats-table"></div>
    </section>
  </main>
  <footer>
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank" class="icon-link">
        <img src="https://n01darts.com/favicon.ico" alt="Nakka" title="Watch Live on Nakka" />
      </a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank" class="icon-link">
        <img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" />
      </a>
    </div>
    <div class="footer-suca">Built by SUCA Analytics</div>
  </footer>
  <script>
    // ... logo mapping, showTab, etc unchanged ...
    const TEAM_LOGOS = {/*... same as before ...*/};
    const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';

    let fixturesCache = [];
    let statsCache = [];
    let statsFiltered = [];
    let statsSort = { key: "", dir: 1 }; // 1=asc, -1=desc

    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      event.target.classList.add('active');
    }

    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        renderFixtures(data.Fixtures);
        renderResults(data.Results, fixturesCache);
        renderStandings(data.Standings);
        renderSquads(data.Squads);
        statsCache = (data.Stats || []).filter(row => row.Player);
        statsFiltered = statsCache.slice();
        renderStats(statsFiltered);
      } catch (err) {
        console.error('Failed to load data:', err);
      }
    }

    // [renderFixtures, renderResults, renderStandings, renderSquads as before]

    // --- STATS + HIGHLIGHTS with Sort/Search ---
    function renderStats(data) {
      // Highlights (min 2 matches)
      const highlightsDefs = [
        { key: "3 Dart Avg", label: "Best 3-Dart Avg", compare: (a,b) => +b["3 Dart Avg"] - +a["3 Dart Avg"] },
        { key: "First 9 Avg", label: "Best First 9 Avg", compare: (a,b) => +b["First 9 Avg"] - +a["First 9 Avg"] },
        { key: "Legs Won", label: "Most Legs Won", compare: (a,b) => +b["Legs Won"] - +a["Legs Won"] },
        { key: "High Finish", label: "Highest Finish", compare: (a,b) => +b["High Finish"] - +a["High Finish"] }
      ];
      const eligible = data.filter(p => Number(p["Match Played"]) >= 2);

      let html = "<h2>Highlights</h2><div class='highlights-grid'>";
      highlightsDefs.forEach(def => {
        const sorted = [...eligible].sort(def.compare);
        const bestVal = sorted.length ? +sorted[0][def.key] : null;
        const bestPlayers = sorted.filter(p => +p[def.key] === bestVal);
        html += `<div class='highlight-card'><strong>${def.label}</strong>
          <p>${
            bestPlayers.length
              ? bestPlayers.map(p => `${p.Player} (${p[def.key]})`).join("<br>")
              : "—"
          }</p></div>`;
      });

      // Best Leg: Find all with lowest Best Leg (exclude 0 or blank)
      const bestLegs = eligible.filter(p => p["Best Leg"] && !isNaN(Number(p["Best Leg"])) && Number(p["Best Leg"]) > 0);
      let minBestLeg = bestLegs.length ? Math.min(...bestLegs.map(p => Number(p["Best Leg"]))) : null;
      let bestLegPlayers = bestLegs.filter(p => Number(p["Best Leg"]) === minBestLeg);

      html += `<div class='highlight-card'><strong>Best Leg</strong>
        <p>${
          bestLegPlayers.length
            ? bestLegPlayers.map(p => `${p.Player} (${p["Best Leg"]})`).join("<br>")
            : "—"
        }</p></div>`;

      html += "</div>";
      document.getElementById("highlights").innerHTML = html;

      // --- Table ---
      if (data.length) {
        const headers = Object.keys(data[0]).filter(
          h => h && h !== "" && h !== undefined && h !== null
        );
        let thead = "<thead><tr>";
        headers.forEach(h => {
          let cls = "sortable";
          if (statsSort.key === h) cls += statsSort.dir === 1 ? " sorted-asc" : " sorted-desc";
          thead += `<th class="${cls}" onclick="sortStats('${h}')">${h}</th>`;
        });
        thead += "</tr></thead>";

        let tbody = "<tbody>";
        data.forEach(row => {
          tbody += "<tr>" + headers.map(h => `<td>${row[h] ?? ""}</td>`).join("") + "</tr>";
        });
        tbody += "</tbody>";

        document.getElementById("stats-table").innerHTML =
          `<div class='table-scroll'><table>${thead}${tbody}</table></div>`;
      } else {
        document.getElementById("stats-table").innerHTML = "<p>No player stats available.</p>";
      }
    }

    // --- Sortable Columns ---
    function sortStats(key) {
      if (statsSort.key === key) {
        statsSort.dir *= -1;
      } else {
        statsSort.key = key;
        statsSort.dir = -1;
      }
      statsFiltered.sort((a, b) => {
        let aVal = a[key], bVal = b[key];
        let nA = parseFloat(aVal), nB = parseFloat(bVal);
        if (!isNaN(nA) && !isNaN(nB)) return statsSort.dir * (nA - nB);
        // fallback: string compare
        return statsSort.dir * String(aVal).localeCompare(String(bVal));
      });
      renderStats(statsFiltered);
    }

    // --- Search/Filter ---
    function filterStats() {
      const query = document.getElementById('statsSearch').value.trim().toLowerCase();
      if (!query) {
        statsFiltered = statsCache.slice();
      } else {
        statsFiltered = statsCache.filter(
          row => (row.Player && row.Player.toLowerCase().includes(query)) ||
                 (row.Team && row.Team.toLowerCase().includes(query))
        );
      }
      renderStats(statsFiltered);
    }

    // ... renderFixtures, renderResults, renderStandings, renderSquads functions as before ...

    loadData();
    setInterval(loadData, 60000);

    // Expose sortStats globally (for inline onclick)
    window.sortStats = sortStats;
    window.filterStats = filterStats;
  </script>
</body>
</html>
