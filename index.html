<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>Royal Darts Premier League 2025</title>
  <meta name="theme-color" content="#191d26">
  <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/174/174855.png" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lucide-static@0.322.0/font/lucide.css"/>
  <style>
    :root {
      --primary: #ffe066;
      --primary-dark: #d5b800;
      --bg: #181b22;
      --nav: #1a1c22;
      --card: #20232c;
      --grey: #bcbcbc;
      --win: #fffbe6;
      --gold: #ffe066;
      --silver: #e5e6ec;
      --elim: #ffd8d8;
    }
    html, body {
      background: var(--bg);
      color: #f6f6f6;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0; padding: 0;
      min-height: 100%;
      overscroll-behavior-y: none;
    }
    header {
      background: #17191f;
      color: var(--primary);
      padding: 1.2rem 0.7rem 1.2rem 0.7rem;
      text-align: left;
      letter-spacing: 0.01em;
      display: flex; align-items: center; gap: 0.8em;
      border-bottom: 2px solid #242634;
    }
    header img { height: 56px; margin-right: 0.6em; }
    header .titlebox { flex:1;}
    header h1 {
      margin: 0 0 0 0;
      font-size: 1.65em;
      font-weight: 800;
      color: var(--primary);
      line-height: 1.08;
      text-shadow: 0 2px 12px #0007;
      letter-spacing: 0.01em;
    }
    /* Nav Bar - Bottom Fixed */
    nav {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      width: 100vw; background: var(--nav); z-index: 200;
      box-shadow: 0 -1px 18px #0002;
      display: flex; justify-content: space-between; align-items: center;
      border-top: 2px solid #222330;
      min-height: 60px;
    }
    nav .tab-btn {
      flex: 1 1 0; border: none; outline: none;
      background: none; color: #ccc;
      padding: 0.5em 0 0.3em 0;
      display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 0.1em;
      font-size: 0.97em; font-weight: 600;
      letter-spacing: 0.01em;
      cursor: pointer;
      transition: color 0.12s, background 0.14s;
      position:relative;
      user-select: none;
      min-width: 0;
    }
    nav .tab-btn.active, nav .tab-btn:active {
      color: var(--primary);
      background: #232439;
      font-weight: 700;
    }
    nav .tab-icon { font-size: 1.32em; margin-bottom: 0.06em;}
    /* Responsive nav labels */
    @media (max-width: 440px) {
      nav .tab-label { font-size:0.97em;}
      header h1 { font-size: 1.17em;}
      header img {height:38px;}
    }
    main { max-width: 490px; margin: 0 auto 75px auto; padding: 1rem 0.3rem 0.2rem 0.3rem; }
    .section { display: none; }
    .section.active { display: block; }
    h2 { color: var(--primary); margin:1.4em 0 0.7em 0.14em;font-size:1.17em;}
    /* Card Style Containers */
    .card {
      background: var(--card);
      border-radius: 17px;
      box-shadow: 0 4px 22px #0002;
      margin-bottom: 1.12em;
      padding: 1.2em 1em 1.1em 1em;
    }
    .card h3 {
      color: var(--primary);
      margin: 0 0 0.35em 0;
      font-weight: 700; font-size:1.15em;
      letter-spacing:0.01em;
    }
    /* Today's Fixtures Table */
    .table-scroll {
      overflow-x: auto;
      width: 100%;
      -webkit-overflow-scrolling: touch;
      border-radius: 8px;
    }
    table {
      width: 100%;
      min-width: 300px;
      background: transparent;
      border-collapse: separate;
      border-spacing: 0;
      margin: 0;
      font-size: 0.98em;
    }
    th,td {
      padding: 0.41em 0.34em;
      text-align: center;
      font-size: 0.97em;
      border-bottom: 1px solid #292942;
      background: transparent;
      color: #e8e8e8;
      max-width: 110px;
      word-break: break-all;
      overflow-wrap: anywhere;
      text-overflow: ellipsis;
    }
    th { color: var(--primary); font-weight:700; background:transparent; border-bottom:2px solid var(--primary-dark);}
    .fixtures-table th, .fixtures-table td { width: 32vw; max-width: 110px; min-width:70px;}
    .team-cell { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    /* Standings Card */
    .standings-table {
      width:100%; border-collapse:separate; border-spacing:0 0.2em;
    }
    .stand-row {
      background: #202336;
      border-radius: 10px;
      color: #fff;
      font-size: 1.02em;
      font-weight: 600;
      box-shadow: 0 2px 10px #0001;
      margin-bottom: 0.17em;
      transition:box-shadow 0.12s;
      position:relative;
    }
    .stand-row.gold { background: #fff9cc; color: #755c00;}
    .stand-row.silver { background: #ececec; color: #232323;}
    .stand-row.elim { background: #ffd8d8; color: #ba2323;}
    .stand-teamlogo { width: 20px; height: 20px; border-radius: 4px; vertical-align: middle; margin-right: 7px;}
    .stand-medal { font-size:1.18em; margin-right:4px; vertical-align: middle;}
    .stand-elim {background:#ba2323; color:#fff; font-size:0.9em; padding:2px 6px;border-radius:7px; margin-left:5px;}
    .stand-points {font-weight:800; font-size:1.01em;}
    /* Results Table */
    .results-table th, .results-table td { min-width: 74px; max-width: 112px;}
    .result-winner { background: #262b2c; color: #ffe066; font-weight:700; }
    .result-teamname { white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:92px; display:inline-block; vertical-align:middle;}
    /* Stats Table */
    #stats-table th, #stats-table td { min-width: 78px; max-width: 124px;}
    #stats-table td.stat-player, #stats-table td.stat-team {white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px;cursor:pointer;}
    #stats-table td.stat-team img {width:13px;height:13px;vertical-align:middle;margin-right:5px;}
    /* Pop-up card for stats */
    #player-popup {
      display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; z-index:250;
      background:rgba(10,12,22,0.93); justify-content:center; align-items:center;
      animation:fadeIn 0.16s;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    #player-popup .popup-card {
      background:#22243a; border-radius:18px; box-shadow:0 3px 28px #0007; padding:1.4em 1.1em; color:#ffe066;
      min-width:210px;max-width:96vw; text-align:center;
    }
    #player-popup .popup-head {font-size:1.23em; font-weight:800; margin-bottom:0.3em;}
    #player-popup .popup-team {color:#a0f3fa;font-weight:700;margin-bottom:0.35em;}
    #player-popup .popup-label {color:#e6e6e6;font-size:1em;margin-top:0.45em;}
    #player-popup .popup-close {color:#fff; font-size:1.23em; background:none; border:none; position:absolute;top:1.1em;right:1.1em;cursor:pointer;}
    /* Misc UI */
    .team-filter-bar {text-align:center; margin-bottom:1.1em;}
    .team-filter-dropdown {
      width:97vw;max-width:270px;margin:0 auto 1em auto;padding:0.38em;font-size:1em;border-radius:7px;border:1.4px solid #282828;background:#1e1e23;color:var(--primary);font-weight:700;outline:none;
    }
    .footer-icons {margin-top:1.3rem;text-align:center;display:flex;justify-content:center;align-items:center;gap:1.2rem;}
    .footer-icons img {height:20px;width:20px;vertical-align:middle;border-radius:3px;background:#222;border:1px solid #292939;box-shadow:0 1px 4px rgba(0,0,0,0.04);}
    .footer-suca {margin-top:0.7rem;text-align:center;color:#bdbdbd;font-size:0.92rem;}
    @media (max-width:520px) {
      main {padding:0.7rem 0.07rem 2.2rem 0.07rem;}
      header img {height:36px;}
      .card {padding:0.85em 0.4em;}
      h2 {font-size:1.05em;}
      .standings-table th, .standings-table td, .fixtures-table th, .fixtures-table td, .results-table th, .results-table td {font-size:0.96em;}
    }
  </style>
</head>
<body>
  <header>
    <img src="logo.png" alt="Logo"/>
    <div class="titlebox">
      <h1>Royal Darts Premier League 2025</h1>
    </div>
  </header>
  <main>
    <!-- DASHBOARD -->
    <section id="dashboard" class="section active">
      <div class="card">
        <h3>Today's Fixtures</h3>
        <div class="table-scroll">
          <table class="fixtures-table" id="dashboard-fixtures-table">
            <thead>
              <tr>
                <th>Time</th>
                <th>Team 1</th>
                <th>vs</th>
                <th>Team 2</th>
              </tr>
            </thead>
            <tbody id="dashboard-fixtures"></tbody>
          </table>
        </div>
      </div>
      <div class="card" style="margin-top:-0.7em;">
        <h3>Quick Standings (Top 3)</h3>
        <div class="table-scroll">
          <table class="standings-table">
            <thead>
              <tr><th>Pos</th><th>Team</th><th>Pts</th></tr>
            </thead>
            <tbody id="dashboard-quick-standings"></tbody>
          </table>
        </div>
      </div>
    </section>
    <!-- FIXTURES -->
    <section id="fixtures" class="section"><div class="card"><h3>Fixtures</h3><div id="fixturesTableContainer"></div></div></section>
    <!-- RESULTS -->
    <section id="results" class="section"><div class="card"><h3>Results</h3><div id="resultsContainer"></div></div></section>
    <!-- STANDINGS -->
    <section id="standings" class="section">
      <div class="card" style="margin-bottom:0.8em;"><h3>Standings</h3>
        <div id="standings-cards"></div>
      </div>
    </section>
    <!-- SQUADS -->
    <section id="squads" class="section"><div class="card"><h3>Squads</h3><div id="squadsContainer">Loading...</div></div></section>
    <!-- STATS -->
    <section id="stats" class="section">
      <div class="card"><h3>Player Stats</h3>
        <div id="stat-highlights"></div>
        <div class="team-filter-bar" id="team-filter-bar"></div>
        <input id="stats-search" type="text" placeholder="Search player or team..." style="margin-bottom:0.8em;padding:0.39em 0.6em;font-size:0.97em;width:98vw;max-width:225px;border-radius:6px;border:1px solid #2a2a2a;display:block;margin:auto;">
        <div id="stats-table"></div>
      </div>
    </section>
  </main>
  <nav>
    <button class="tab-btn active" onclick="showTab('dashboard')"><span class="tab-icon lucide lucide-home"></span><span class="tab-label">Home</span></button>
    <button class="tab-btn" onclick="showTab('fixtures')"><span class="tab-icon lucide lucide-calendar-days"></span><span class="tab-label">Fixtures</span></button>
    <button class="tab-btn" onclick="showTab('results')"><span class="tab-icon lucide lucide-list-start"></span><span class="tab-label">Results</span></button>
    <button class="tab-btn" onclick="showTab('standings')"><span class="tab-icon lucide lucide-trophy"></span><span class="tab-label">Standings</span></button>
    <button class="tab-btn" onclick="showTab('stats')"><span class="tab-icon lucide lucide-bar-chart"></span><span class="tab-label">Stats</span></button>
  </nav>
  <!-- Player popup -->
  <div id="player-popup" onclick="hidePlayerPopup(event)">
    <div class="popup-card"></div>
    <button class="popup-close" onclick="hidePlayerPopup(event)">&times;</button>
  </div>
  <footer style="margin-bottom:80px">
    <div class="footer-icons">
      <a href="https://n01darts.com/n01/tournament/comp.php?id=t_NI0o_4352&tab=live" target="_blank"><img src="https://n01darts.com/favicon.ico" alt="Nakka" title="Watch Live on Nakka" /></a>
      <a href="https://www.instagram.com/royaldarts_rcgc" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174855.png" alt="Instagram" title="Follow us on Instagram" /></a>
    </div>
    <div class="footer-suca">Built by SUCA Analytics</div>
  </footer>
  <script>
    // TEAM LOGOS, API URL
    const TEAM_LOGOS = {
      "Balaji Darts": "team_logos/Balaji-Darts.avif",
      "Biscotti Barrels": "team_logos/Biscotti-Barrels.avif",
      "BLC High Rollers": "team_logos/BLC-High-Rollers.avif",
      "Bullseye Bandits": "team_logos/Bullseye-Bandits.avif",
      "City Knights": "team_logos/City-Knights.avif",
      "Hugo & Finn": "team_logos/Hugo-&-Finn.png",
      "Keventer Eagle Eye": "team_logos/Keventer-Eagle-Eye.avif",
      "PKS Titans": "team_logos/PKS-Titans.avif",
      "Purti Forever": "team_logos/Purti-Forever.avif",
      "Rama Darts": "team_logos/Rama-Darts.png",
      "Royals Super Knights": "team_logos/Royals-Super-Knights.avif",
      "RSV Rising Stars": "team_logos/RSV-Rising-Stars.avif",
      "The Panthers": "team_logos/The-Panthers.avif",
      "Tons of Bull": "team_logos/Tons-of-Bull.avif",
      "UGW": "team_logos/UGW.png",
      "Vyana Warriors": "team_logos/Vyana-Warriors.avif"
    };
    const API_URL = 'https://script.google.com/macros/s/AKfycby6BCE5cyBaxpz-Jt-TeRH6k5Jeq-vqelr8S7rt32e7wFjBzEvuBrYi4yPaEBz2Kari/exec';

    // Nav functionality
    function showTab(tabId) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabId).classList.add('active');
      let navBtn = Array.from(document.querySelectorAll('nav .tab-btn')).find(b => b.innerText.toLowerCase().includes(tabId));
      if(navBtn) navBtn.classList.add('active');
      window.scrollTo({top:0,behavior:'smooth'});
    }
    // Data cache
    let fixturesCache = [], standingsCache = [], statsCache = [], bestLegCache = [], squadsCache = [], resultsCache = [];
    let statsSortKey = null, statsSortDir = 1, statsSearchTerm = "", teamFilter = null;
    const STATS_HIDE_COLUMNS = new Set([
      "Keep", "Break", "Second Legs", "Break Legs", "Total Score", "Total Darts", "Group", "Best Leg", "Worst Leg"
    ]);

    // API Fetch & Render all
    async function loadData() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        fixturesCache = data.Fixtures || [];
        standingsCache = data.Standings || [];
        statsCache = (data.Stats || []).filter(row => row.Player);
        bestLegCache = (data["Best Leg"] || []).filter(row => row["Best Leg"]);
        squadsCache = data.Squads || [];
        resultsCache = data.Results || [];
        renderDashboardFixtures();
        renderDashboardQuickStandings();
        renderFixtures(fixturesCache);
        renderResults(resultsCache, fixturesCache);
        renderStandings();
        renderSquads(squadsCache);
        renderStatHighlights(statsCache, bestLegCache);
        renderStats(statsCache, bestLegCache);
        renderTeamFilter(statsCache);
      } catch (err) {console.error('Failed to load data:', err);}
    }

    // --- DASHBOARD: Today's Fixtures (Time only, uniform width) ---
    function renderDashboardFixtures() {
      const [istStart, istEnd] = getISTTodayRange();
      const todaysFixtures = fixturesCache.filter(fix => {
        const d = new Date(fix.Date);
        return d >= istStart && d <= istEnd;
      });
      let html = '';
      if (!todaysFixtures.length) {
        html = `<tr><td colspan="4" style="color:#ffec8a;">No fixtures today.</td></tr>`;
      } else {
        todaysFixtures.forEach(f => {
          html += `<tr>
            <td>${new Date(f.Time).toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit',hour12:true,timeZone:'Asia/Kolkata'})}</td>
            <td class="team-cell">${f['Team 1'] || ""}</td>
            <td>vs</td>
            <td class="team-cell">${f['Team 2'] || ""}</td>
          </tr>`;
        });
      }
      document.getElementById('dashboard-fixtures').innerHTML = html;
    }
    // --- Dashboard: Quick Standings (Top 3) ---
    function renderDashboardQuickStandings() {
      const standings = standingsCache.sort((a,b)=>b.Points-a.Points || b.LD-a.LD).slice(0,3);
      let html = '';
      standings.forEach((s,i) => {
        html += `<tr>
          <td>${i+1}</td>
          <td class="team-cell">${s.Team}</td>
          <td class="stand-points">${s.Points}</td>
        </tr>`;
      });
      document.getElementById('dashboard-quick-standings').innerHTML = html;
    }
    // --- FIXTURES ---
    function renderFixtures(fixtures) {
      const container = document.getElementById('fixturesTableContainer');
      if (!fixtures.length) {
        container.innerHTML = '<div class="table-scroll"><table><tbody><tr><td>Loading...</td></tr></tbody></table></div>';
        return;
      }
      const byDate = {};
      fixtures.forEach(f => {
        const d = new Date(f.Date).toDateString();
        if (!byDate[d]) byDate[d] = [];
        byDate[d].push(f);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading" style="color:#ffe066;">${dateStr}</div>
        <div class="table-scroll">
        <table class="fixtures-table">
          <thead>
            <tr><th>Time</th><th>Team 1</th><th></th><th>Team 2</th></tr>
          </thead>
          <tbody>`;
        byDate[dateStr].forEach(f => {
          html += `<tr>
              <td>${new Date(f.Time).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</td>
              <td class="team-cell">${f['Team 1'] || ""}</td>
              <td>vs</td>
              <td class="team-cell">${f['Team 2'] || ""}</td>
            </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      container.innerHTML = html;
    }
    // --- RESULTS (Mobile-friendly, curl team names, highlight winner) ---
    function renderResults(results, fixtures) {
      const fixtureDateMap = {};
      fixtures.forEach(fix => {
        const t1 = fix["Team 1"], t2 = fix["Team 2"];
        const dateStr = new Date(fix.Date).toDateString();
        fixtureDateMap[`${t1}|${t2}`] = dateStr;
        fixtureDateMap[`${t2}|${t1}`] = dateStr;
      });
      const byDate = {};
      results.forEach(r => {
        let dateVal = "";
        if (r.Date && r.Date !== "null" && r.Date !== "" && r.Date !== undefined) {
          dateVal = new Date(r.Date).toDateString();
        } else {
          const t1 = r["Team 1"], t2 = r["Team 2"];
          dateVal = fixtureDateMap[`${t1}|${t2}`] || fixtureDateMap[`${t2}|${t1}`] || "Unknown Date";
        }
        if (!byDate[dateVal]) byDate[dateVal] = [];
        byDate[dateVal].push(r);
      });
      let html = '';
      Object.keys(byDate).sort((a, b) => new Date(a) - new Date(b)).forEach(dateStr => {
        html += `<div class="date-heading" style="color:#ffe066;">${dateStr}</div>
        <div class="table-scroll">
          <table class="results-table">
            <thead>
              <tr>
                <th>Avg 1</th>
                <th>Team 1</th>
                <th>Score</th>
                <th>vs</th>
                <th>Score</th>
                <th>Team 2</th>
                <th>Avg 2</th>
              </tr>
            </thead>
            <tbody>`;
        byDate[dateStr].forEach(r => {
          const win1 = +r['Legs 1'] > +r['Legs 2'];
          const win2 = +r['Legs 2'] > +r['Legs 1'];
          html += `<tr>
            <td>${r['Avg 1']||""}</td>
            <td class="result-teamname${win1?" result-winner":""}">${r['Team 1']||""}</td>
            <td${win1?' class="result-winner"':''}>${r['Legs 1']||""}</td>
            <td>vs</td>
            <td${win2?' class="result-winner"':''}>${r['Legs 2']||""}</td>
            <td class="result-teamname${win2?" result-winner":""}">${r['Team 2']||""}</td>
            <td>${r['Avg 2']||""}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;
      });
      document.getElementById('resultsContainer').innerHTML = html || '';
    }
    // --- PREMIUM STANDINGS TABLE ---
    function renderStandings() {
      const groupA = standingsCache.filter(s => s.Group?.toUpperCase() === 'A');
      const groupB = standingsCache.filter(s => s.Group?.toUpperCase() === 'B');
      document.getElementById('standings-cards').innerHTML =
        standingsGroupCard('Group A', groupA) + standingsGroupCard('Group B', groupB);
    }
    function standingsGroupCard(title, arr) {
      arr = arr.sort((a, b) => b.Points - a.Points || b.LD - a.LD);
      let html = `<div style="font-weight:800;font-size:1.08em;color:#ffe066;margin-bottom:0.36em;">${title}</div>
      <table class="standings-table"><thead>
        <tr><th>Pos</th><th>Team</th><th>P</th><th>W</th><th>L</th><th>Pts</th><th>Avg</th></tr>
      </thead><tbody>`;
      arr.forEach((s,i) => {
        let rowClass = i<3?"gold":i<6?"silver":"elim";
        let medal = i==0?`<span class="stand-medal">&#129351;</span>`:i==1?`<span class="stand-medal">&#129352;</span>`:i==2?`<span class="stand-medal">&#129353;</span>`:"";
        let elim = i>5?`<span class="stand-elim">Elim</span>`:"";
        html += `<tr class="stand-row ${rowClass}">
          <td>${i+1}</td>
          <td class="team-cell"><img class="stand-teamlogo" src="${TEAM_LOGOS[s.Team]||''}" alt="">${medal}${s.Team}${elim}</td>
          <td>${s.P}</td><td>${s.W}</td><td>${s.L}</td>
          <td class="stand-points">${s.Points}</td>
          <td>${s.Avg}</td>
        </tr>`;
      });
      html += "</tbody></table>";
      return html;
    }
    // --- SQUADS ---
    function renderSquads(squads) {
      const container = document.getElementById('squadsContainer');
      if (!squads.length) { container.innerHTML = 'Loading...'; return; }
      const teams = [...new Set(squads.map(s => s.Team))];
      let html = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:1.1em;">';
      teams.forEach(team => {
        const logo = TEAM_LOGOS[team] || "";
        const players = squads.filter(s => s.Team === team).map(p => `<div style="font-size:0.95em;">${p.Player}</div>`).join('');
        html += `<div style="background:#22243a;border-radius:10px;padding:0.7em;text-align:center;">
          <img src="${logo}" alt="${team}" style="width:30px;height:30px;border-radius:7px;object-fit:contain;">
          <div style="font-weight:700;color:#ffe066;margin:0.27em 0 0.07em 0;">${team}</div>
          <div style="font-size:0.94em;color:#eee;">${players}</div>
        </div>`;
      });
      html += '</div>';
      container.innerHTML = html;
    }
    // --- STATS HIGHLIGHTS & TABLE ---
    function renderStatHighlights(stats, bestLegsSheet) {
      const defs = [
        {key:"3 Dart Avg", label:"Best 3-Dart Avg"},
        {key:"First 9 Avg", label:"Best First 9 Avg"},
        {key:"Legs Won", label:"Most Legs Won"},
        {key:"High Finish", label:"Highest Finish"}
      ];
      const eligible = stats.filter(p => Number(p["Match Played"]) >= 2);
      let html = `<div class="stat-high-bar" style="display:flex;gap:0.55em;flex-wrap:wrap;justify-content:center;">`;
      defs.forEach(def => {
        const sorted = [...eligible].sort((a,b) => +b[def.key] - +a[def.key]);
        const player = sorted[0];
        if (!player) return;
        const team = player.Team || "";
        const logo = TEAM_LOGOS[team] || "";
        let val = player[def.key] ?? "—";
        html += `<div class="stat-high-card" style="background:#242545;">
          <div class="stat-high-label">${def.label}</div>
          <div class="stat-high-main">${val}</div>
          <div class="stat-high-player">${logo?`<img src="${logo}">`:''}${player.Player} (${team})</div>
        </div>`;
      });
      // Best Leg (from sheet)
      if (bestLegsSheet && bestLegsSheet.length) {
        let best = bestLegsSheet.sort((a,b)=>Number(a["Best Leg"])-Number(b["Best Leg"]))[0];
        const logo = TEAM_LOGOS[best.Team] || "";
        html += `<div class="stat-high-card" style="background:#242545;">
          <div class="stat-high-label">Best Leg</div>
          <div class="stat-high-main">${best["Best Leg"]}</div>
          <div class="stat-high-player">${logo?`<img src="${logo}">`:''}${best.Players} (${best.Team})</div>
        </div>`;
      }
      html += "</div>";
      document.getElementById('stat-highlights').innerHTML = html;
    }
    function renderTeamFilter(stats) {
      const bar = document.getElementById('team-filter-bar');
      if (!stats || !stats.length) { bar.innerHTML = ''; return;}
      const allTeams = Array.from(new Set(stats.map(p => p.Team).filter(Boolean))).sort();
      let html = `<select class="team-filter-dropdown" onchange="setTeamFilter(this.value)">
        <option value="">All Teams</option>`;
      allTeams.forEach(team => {
        html += `<option value="${team.replace(/"/g, "&quot;")}"${teamFilter===team?" selected":""}>${team}</option>`;
      });
      html += `</select>`;
      bar.innerHTML = html;
    }
    window.setTeamFilter = function(team) {
      teamFilter = team || null;
      renderStats(statsCache, bestLegCache);
    };
    // --- Stats Table, with player pop-up on name click ---
    function renderStats(stats, bestLegsSheet) {
      const searchInput = document.getElementById('stats-search');
      if (searchInput && !searchInput._listenerAdded) {
        searchInput.addEventListener("input", () => {
          statsSearchTerm = searchInput.value.trim().toLowerCase();
          renderStats(statsCache, bestLegCache);
        });
        searchInput._listenerAdded = true;
      }
      let filteredStats = stats;
      if (teamFilter) filteredStats = filteredStats.filter(p => p.Team === teamFilter);
      if (statsSearchTerm) {
        filteredStats = filteredStats.filter(
          p => (p.Player && p.Player.toLowerCase().includes(statsSearchTerm)) ||
               (p.Team && p.Team.toLowerCase().includes(statsSearchTerm))
        );
      }
      if (statsSortKey) {
        filteredStats = [...filteredStats].sort((a, b) => {
          let v1 = a[statsSortKey], v2 = b[statsSortKey];
          let n1 = parseFloat(v1), n2 = parseFloat(v2);
          if (!isNaN(n1) && !isNaN(n2)) {
            return statsSortDir * (n1 - n2);
          } else {
            return statsSortDir * (String(v1).localeCompare(String(v2)));
          }
        });
      }
      if (filteredStats.length) {
        const wantedHeaders = Object.keys(filteredStats[0]).filter(
          h => h && h !== "" && h !== undefined && h !== null && !STATS_HIDE_COLUMNS.has(h)
        );
        let table = "<div class='table-scroll'><table><thead><tr>";
        wantedHeaders.forEach(h => {
          let dirArrow = "";
          if (statsSortKey === h) dirArrow = statsSortDir > 0 ? " ▲" : " ▼";
          table += `<th onclick="setStatsSort('${h}')">${h}${dirArrow}</th>`;
        });
        table += "</tr></thead><tbody>";
        filteredStats.forEach(row => {
          table += "<tr>" + wantedHeaders.map(h => {
            let val = row[h] ?? "";
            if (h === "Win Rate (Sets)" || h === "Win Rate (Legs)") {
              val = isNaN(parseFloat(val)) ? "" : `${Math.round(parseFloat(val) * 100)}%`;
            }
            if (h === "Player") {
              return `<td class="stat-player" title="${val}" onclick="showPlayerPopup('${row.Player.replace(/'/g,"\\'")}')">${val}</td>`;
            }
            if (h === "Team" && TEAM_LOGOS[val]) {
              return `<td class="stat-team" title="${val}"><img src="${TEAM_LOGOS[val]}" alt="${val}">${val}</td>`;
            }
            return `<td>${val}</td>`;
          }).join("") + "</tr>";
        });
        table += "</tbody></table></div>";
        document.getElementById("stats-table").innerHTML = table;
      } else {
        document.getElementById("stats-table").innerHTML = "<p>No player stats available.</p>";
      }
    }
    window.setStatsSort = function(h) {
      if (statsSortKey === h) {
        statsSortDir = -statsSortDir;
      } else {
        statsSortKey = h;
        statsSortDir = 1;
      }
      renderStats(statsCache, bestLegCache);
    };
    // Player pop-up functionality
    function showPlayerPopup(playerName) {
      let p = statsCache.find(s => s.Player === playerName);
      if (!p) return;
      let logo = p.Team && TEAM_LOGOS[p.Team] ? `<img src="${TEAM_LOGOS[p.Team]}" style="width:33px;height:33px;border-radius:6px;vertical-align:middle;margin-bottom:0.24em;"><br>` : "";
      let card = `<div class="popup-card">
        <div class="popup-head">${logo}${p.Player}</div>
        <div class="popup-team">${p.Team||""}</div>
        <div style="color:#ffe066;font-size:1em;font-weight:700;">Stats</div>
        ${Object.keys(p).map(h => {
          if (["Player", "Team"].includes(h) || STATS_HIDE_COLUMNS.has(h) || !p[h]) return "";
          return `<div class="popup-label"><span style="color:#a0f3fa;font-weight:600;">${h}:</span> ${p[h]}</div>`;
        }).join("")}
      </div>`;
      document.querySelector("#player-popup .popup-card").innerHTML = card;
      document.getElementById("player-popup").style.display = "flex";
    }
    function hidePlayerPopup(e) {
      if (!e || !e.target || e.target.id === "player-popup" || e.target.classList.contains("popup-close"))
        document.getElementById("player-popup").style.display = "none";
    }
    // IST Today util
    function getISTTodayRange() {
      const now = new Date();
      const IST_OFFSET = 330;
      const local = new Date(now.getTime() + ((IST_OFFSET - now.getTimezoneOffset())*60*1000));
      const istYear = local.getFullYear(), istMonth = local.getMonth(), istDay = local.getDate();
      const istStart = new Date(Date.UTC(istYear, istMonth, istDay, 0, -IST_OFFSET, 0));
      const istEnd = new Date(Date.UTC(istYear, istMonth, istDay, 23, 59-IST_OFFSET, 59));
      return [istStart, istEnd, ""];
    }
    loadData();
    setInterval(loadData, 60000);
  </script>
</body>
</html>
